<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070a12" />
  <title>Racemann Pilot — Live</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#070a12;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.48);

      --purple:#c084fc;
      --green:#4ade80;
      --red:#fb7185;

      --r:18px;
      --shadow: 0 14px 50px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(59,130,246,.16), transparent 60%),
        radial-gradient(800px 480px at 100% 0%, rgba(192,132,252,.18), transparent 55%),
        radial-gradient(700px 520px at 60% 120%, rgba(74,222,128,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    .app{
      height:100dvh;
      padding:
        calc(env(safe-area-inset-top) + 8px)
        calc(env(safe-area-inset-right) + 8px)
        calc(env(safe-area-inset-bottom) + 8px)
        calc(env(safe-area-inset-left) + 8px);
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    /* TOP (минимально) */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex:0 0 auto;
    }
    .title{
      font-weight:900;
      font-size:18px;
      letter-spacing:.2px;
      line-height:1.1;
      white-space:nowrap;
    }
    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .chip{
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size:12px;
      color:var(--muted);
      box-shadow: 0 8px 24px rgba(0,0,0,.28);
      white-space:nowrap;
    }
    .chip b{ color:var(--text); font-weight:850; }
    .chip.status{
      border-color: rgba(192,132,252,.35);
      background: rgba(192,132,252,.10);
      color: rgba(192,132,252,.95);
    }

    /* MAIN */
    .main{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:8px;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panelHead{
      padding:8px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .panelHead .h{
      font-weight:900;
      letter-spacing:.2px;
    }

    .panelBody{
      padding:10px;
      min-height:0;
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* LEFT */
    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      flex:0 0 auto;
    }
    .card{
      background:var(--panel2);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:0;
    }
    .label{
      font-size:11px;
      letter-spacing:1.5px;
      color:var(--muted2);
    }

    /* КРУПНЕЕ цифры */
    .time{
      font-size:56px;
      font-weight:950;
      letter-spacing:.6px;
      line-height:1;
    }
    .time.purple{ color: var(--purple); }

    .subrow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:2px;
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.purple{
      border-color: rgba(192,132,252,.35);
      background: rgba(192,132,252,.12);
      color: rgba(192,132,252,.95);
      font-weight:900;
    }
    .pill.good{
      border-color: rgba(74,222,128,.30);
      background: rgba(74,222,128,.10);
      color: rgba(74,222,128,.95);
      font-weight:900;
    }
    .pill.bad{
      border-color: rgba(251,113,133,.30);
      background: rgba(251,113,133,.10);
      color: rgba(251,113,133,.95);
      font-weight:900;
    }

    .posGrid{
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap:8px;
      flex:1;
      min-height:0;
    }

    .posCard, .deltaRow{
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      min-height:0;
    }

    .posBig{
      font-size:58px;
      font-weight:980;
      letter-spacing:.6px;
      line-height:1;
      margin-top:2px;
    }

    .deltas{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .deltaRow .val{
      font-size:40px;
      font-weight:950;
      letter-spacing:.4px;
      line-height:1.1;
      margin-top:2px;
    }

    /* кнопки */
    .btnRow{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .btn{
      flex:1;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.08);
      color:var(--text);
    }
    .btn.primary{
      border-color: rgba(192,132,252,.35);
      background: rgba(192,132,252,.14);
    }

    /* RIGHT */
    .lapsList{
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-right:2px;
    }
    .lapItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    .lapLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .lapLeft .n{
      font-size:11px;
      color:var(--muted2);
    }
    .lapLeft .t{
      font-size:22px;         /* крупнее */
      font-weight:950;
      letter-spacing:.3px;
      white-space:nowrap;
    }

    @media (max-width: 820px){
      .main{ grid-template-columns: 1fr; }
    }

    /* если очень мало высоты — ещё ужимаем */
    @media (max-height: 520px){
      .title{ font-size:16px; }
      .time{ font-size:48px; }
      .posBig{ font-size:50px; }
      .deltaRow .val{ font-size:34px; }
      .panelHead{ padding:7px 9px; }
      .panelBody{ padding:9px; gap:7px; }
      .card{ padding:9px; }
      .posCard, .deltaRow{ padding:9px; }
      .btn{ padding:11px 12px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="title">Тренировка</div>
      <div class="chips">
        <div class="chip">Карт: <b id="kartNum">14</b></div>
        <div class="chip status"><b id="statusText">Едет</b></div>
        <div class="chip"><b id="sessionTime">00:00</b></div>
        <div class="chip">Кругов: <b id="lapsCount">0</b></div>
      </div>
    </div>

    <div class="main">
      <!-- LEFT -->
      <div class="panel">
        <div class="panelHead">
          <div class="h">Сводка</div>
        </div>

        <div class="panelBody">
          <div class="cards">
            <div class="card">
              <div class="label">LAST</div>
              <div class="time" id="lastLap">—</div>
              <div class="subrow">
                <span class="pill" id="lastTag">—</span>
                <span class="pill" id="deltaToBestPill">Δ: —</span>
              </div>
            </div>

            <div class="card">
              <div class="label">BEST</div>
              <div class="time purple" id="bestLap">—</div>
              <div class="subrow">
                <span class="pill purple" id="bestTag">BEST</span>
              </div>
            </div>
          </div>

          <div class="posGrid">
            <div class="posCard">
              <div class="label">ПОЗИЦИЯ</div>
              <div class="posBig" id="posText">—</div>

              <div class="btnRow">
                <button class="btn primary" id="addLapBtn">+ Круг</button>
                <button class="btn" id="resetBtn">Сброс</button>
              </div>
            </div>

            <div class="deltas">
              <div class="deltaRow">
                <div class="label">Δ BEST</div>
                <div class="val" id="deltaAbs">—</div>
              </div>

              <div class="deltaRow">
                <div class="label">Δ ВПЕРЕДИ</div>
                <div class="val" id="deltaAhead">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="panelHead">
          <div class="h">Круги</div>
        </div>
        <div class="panelBody" style="padding:10px;">
          <div class="lapsList" id="lapsList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatMMSS(totalSeconds){
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return `${pad2(m)}:${pad2(s)}`;
    }
    function toFixed3(x){
      return (Math.round(x * 1000) / 1000).toFixed(3);
    }
    function deltaLabel(delta){
      const sign = delta > 0 ? "+" : (delta < 0 ? "−" : "");
      return sign + toFixed3(Math.abs(delta));
    }
    function randLap(){
      const v = 31.8 + Math.random() * 1.4; // 31.800..33.200
      return Number(toFixed3(v));
    }

    let sessionSeconds = 0;
    let kart = 14;
    let status = "Едет";

    let laps = []; // {n, time}
    let myBest = null;
    let myLast = null;

    const rivals = [
      { best: 32.210 },
      { best: 32.330 },
      { best: 32.480 },
      { best: 32.620 },
      { best: 32.860 },
      { best: 33.050 },
    ];

    function maybeUpdateRivals(){
      if (Math.random() < 0.35){
        const idx = Math.floor(Math.random()*rivals.length);
        const tweak = (Math.random()-0.5)*0.10;
        rivals[idx].best = Number(toFixed3(Math.max(31.7, rivals[idx].best + tweak)));
      }
      if (Math.random() < 0.18){
        const idx = Math.floor(Math.random()*rivals.length);
        const improve = -Math.random()*0.08;
        rivals[idx].best = Number(toFixed3(Math.max(31.7, rivals[idx].best + improve)));
      }
    }

    function computeRanking(){
      const me = myBest ?? 999;
      const all = rivals.map(r => r.best).concat([me]).sort((a,b)=>a-b);
      const pos = all.indexOf(me) + 1;
      const absBest = all[0];
      const aheadBest = pos > 1 ? all[pos-2] : null;
      return { pos, total: all.length, absBest, aheadBest };
    }

    function renderTop(){
      $("kartNum").textContent = kart;
      $("statusText").textContent = status;
      $("sessionTime").textContent = formatMMSS(sessionSeconds);
      $("lapsCount").textContent = String(laps.length);
    }

    function setPill(el, text, kind){
      el.textContent = text;
      el.classList.remove("purple","good","bad");
      if (kind) el.classList.add(kind);
    }

    function renderSummary(){
      $("lastLap").textContent = myLast == null ? "—" : toFixed3(myLast);
      $("bestLap").textContent = myBest == null ? "—" : toFixed3(myBest);

      $("lastLap").classList.remove("purple");
      if (myLast != null && myBest != null && myLast === myBest){
        $("lastLap").classList.add("purple");
        setPill($("lastTag"), "BEST", "purple");
      } else {
        setPill($("lastTag"), myLast == null ? "—" : "OK", "");
      }

      const { pos, total, absBest, aheadBest } = computeRanking();
      $("posText").textContent = (myBest == null) ? "—" : `${pos}/${total}`;

      if (myBest == null){
        $("deltaAbs").textContent = "—";
        $("deltaAhead").textContent = "—";
        setPill($("deltaToBestPill"), "Δ: —", "");
        return;
      }

      const dAbs = myBest - absBest;
      const dAhead = aheadBest == null ? 0 : (myBest - aheadBest);

      $("deltaAbs").textContent = deltaLabel(dAbs);
      $("deltaAhead").textContent = aheadBest == null ? "0.000" : deltaLabel(dAhead);

      $("deltaAbs").style.color = dAbs <= 0 ? "rgba(74,222,128,.95)" : "rgba(251,113,133,.95)";
      $("deltaAhead").style.color = (aheadBest == null || dAhead <= 0) ? "rgba(74,222,128,.95)" : "rgba(251,113,133,.95)";

      const dToBest = myLast == null ? null : (myLast - myBest);
      if (dToBest == null) setPill($("deltaToBestPill"), "Δ: —", "");
      else {
        const txt = `Δ: ${deltaLabel(dToBest)}`;
        if (myLast === myBest) setPill($("deltaToBestPill"), txt, "purple");
        else setPill($("deltaToBestPill"), txt, dToBest <= 0 ? "good" : "bad");
      }
    }

    function renderLaps(){
      const box = $("lapsList");
      box.innerHTML = "";
      laps.slice().reverse().forEach(l => {
        const isBest = (myBest != null && l.time === myBest);
        const div = document.createElement("div");
        div.className = "lapItem";
        div.innerHTML = `
          <div class="lapLeft">
            <div class="n">#${l.n}</div>
            <div class="t" style="${isBest ? 'color: var(--purple);' : ''}">${toFixed3(l.time)}</div>
          </div>
          <div>
            <span class="pill ${isBest ? 'purple' : ''}">${isBest ? 'BEST' : ''}</span>
          </div>
        `;
        box.appendChild(div);
      });
    }

    function addLap(){
      maybeUpdateRivals();
      const time = randLap();
      const n = laps.length + 1;
      laps.push({ n, time });

      myLast = time;
      if (myBest == null) myBest = time;
      myBest = Math.min(myBest, time);

      renderTop();
      renderSummary();
      renderLaps();
    }

    function resetAll(){
      sessionSeconds = 0;
      laps = [];
      myBest = null;
      myLast = null;
      rivals[0].best = 32.210;
      rivals[1].best = 32.330;
      rivals[2].best = 32.480;
      rivals[3].best = 32.620;
      rivals[4].best = 32.860;
      rivals[5].best = 33.050;

      renderTop();
      renderSummary();
      renderLaps();
    }

    $("addLapBtn").addEventListener("click", addLap);
    $("resetBtn").addEventListener("click", resetAll);

    renderTop();
    renderSummary();
    renderLaps();

    setInterval(() => {
      sessionSeconds += 1;
      renderTop();
    }, 1000);
  </script>
</body>
</html>