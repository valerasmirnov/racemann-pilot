<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070a12" />
  <title>Racemann Pilot — Live</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#070a12;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --muted2:rgba(234,240,255,.52);

      /* пурпур (как просил) */
      --purple:#c084fc;
      --purple2:rgba(192,132,252,.16);

      --green:#4ade80;
      --red:#fb7185;

      --r:18px;
      --shadow: 0 14px 50px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(59,130,246,.16), transparent 60%),
        radial-gradient(800px 480px at 100% 0%, rgba(192,132,252,.18), transparent 55%),
        radial-gradient(700px 520px at 60% 120%, rgba(74,222,128,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden; /* важно: без лишней прокрутки */
    }

    .app{
      height:100dvh;
      padding:
        calc(env(safe-area-inset-top) + 10px)
        calc(env(safe-area-inset-right) + 10px)
        calc(env(safe-area-inset-bottom) + 10px)
        calc(env(safe-area-inset-left) + 10px);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    /* компактная верхняя строка (чтобы влезало) */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:160px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      line-height:1.1;
      letter-spacing:.2px;
    }
    .title .sub{
      font-size:12px;
      color:var(--muted2);
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size:12.5px;
      color:var(--muted);
      box-shadow: 0 8px 24px rgba(0,0,0,.28);
      white-space:nowrap;
    }
    .chip b{ color:var(--text); font-weight:750; }
    .chip.status{
      border-color: rgba(192,132,252,.35);
      background: rgba(192,132,252,.10);
      color: rgba(192,132,252,.95);
    }

    /* MAIN: слева 2/3, справа 1/3 */
    .main{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:10px;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panelHead{
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .panelHead .h{
      font-weight:800;
      letter-spacing:.2px;
    }
    .panelHead .hint{
      color:var(--muted2);
      font-size:12px;
      white-space:nowrap;
    }

    .panelBody{
      padding:12px;
      min-height:0;
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* LEFT: сверху две карточки, ниже инфо о позиции */
    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      flex:0 0 auto;
    }

    .card{
      background:var(--panel2);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:0;
    }

    .label{
      font-size:12px;
      letter-spacing:1.4px;
      color:var(--muted2);
    }

    .time{
      font-size:42px;
      font-weight:900;
      letter-spacing:.6px;
      line-height:1;
    }

    .time.purple{ color: var(--purple); }
    .subrow{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.purple{
      border-color: rgba(192,132,252,.35);
      background: rgba(192,132,252,.12);
      color: rgba(192,132,252,.95);
      font-weight:800;
    }
    .pill.good{
      border-color: rgba(74,222,128,.30);
      background: rgba(74,222,128,.10);
      color: rgba(74,222,128,.95);
      font-weight:800;
    }
    .pill.bad{
      border-color: rgba(251,113,133,.30);
      background: rgba(251,113,133,.10);
      color: rgba(251,113,133,.95);
      font-weight:800;
    }

    .posGrid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:10px;
      flex:1;
      min-height:0;
    }

    .posCard{
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10cg.
      min-height:0;
    }

    .posBig{
      font-size:44px;
      font-weight:950;
      letter-spacing:.6px;
      line-height:1;
    }

    .posSmall{
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
      line-height:1.25;
    }

    .deltas{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .deltaRow{
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .deltaRow .val{
      font-size:28px;
      font-weight:900;
      letter-spacing:.4px;
      line-height:1.1;
    }

    /* RIGHT: список кругов */
    .lapsList{
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-right:2px;
    }

    .lapItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }

    .lapLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .lapLeft .n{
      font-size:12px;
      color:var(--muted2);
    }
    .lapLeft .t{
      font-size:18px;
      font-weight:850;
      letter-spacing:.3px;
      white-space:nowrap;
    }

    .lapRight{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      flex:0 0 auto;
    }

    /* адаптация под мобильный: в portrait делаем вертикально */
    @media (max-width: 820px){
      .main{ grid-template-columns: 1fr; }
    }

    /* Если высоты мало (ландшафт на iPhone) — ещё ужмём */
    @media (max-height: 520px){
      .title h1{ font-size:16px; }
      .time{ font-size:36px; }
      .posBig{ font-size:38px; }
      .deltaRow .val{ font-size:24px; }
      .panelHead{ padding:8px 10px; }
      .panelBody{ padding:10px; gap:8px; }
      .card{ padding:10px; }
      .posCard, .deltaRow{ padding:10px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="title">
        <h1>Тренировка</h1>
        <div class="sub">Live • UX заезда</div>
      </div>

      <div class="chips">
        <div class="chip">Карт: <b id="kartNum">14</b></div>
        <div class="chip status">Статус: <b id="statusText">Едет</b></div>
        <div class="chip">Сессия: <b id="sessionTime">00:00</b></div>
        <div class="chip">Кругов: <b id="lapsCount">0</b></div>
      </div>
    </div>

    <div class="main">
      <!-- LEFT 2/3 -->
      <div class="panel">
        <div class="panelHead">
          <div class="h">Сводка</div>
          <div class="hint">заезд</div>
        </div>

        <div class="panelBody">
          <div class="cards">
            <div class="card">
              <div class="label">LAST LAP</div>
              <div class="time" id="lastLap">—</div>
              <div class="subrow">
                <span class="pill" id="lastTag">—</span>
                <span class="pill" id="deltaToBestPill">Δ к best: —</span>
              </div>
            </div>

            <div class="card">
              <div class="label">BEST LAP</div>
              <div class="time purple" id="bestLap">—</div>
              <div class="subrow">
                <span class="pill purple" id="bestTag">BEST</span>
                <span class="pill" id="bestHint">Лучший круг в сессии</span>
              </div>
            </div>
          </div>

          <div class="posGrid">
            <div class="posCard">
              <div>
                <div class="label">ПОЗИЦИЯ</div>
                <div class="posBig" id="posText">—</div>
                <div class="posSmall" id="posSub">по времени лучшего круга (тест)</div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="addLapBtn" style="flex:1; border-radius:14px; padding:12px 14px; font-weight:850; border:1px solid rgba(192,132,252,.35); background: rgba(192,132,252,.14); color:var(--text);">
                  + Круг
                </button>
                <button id="resetBtn" style="border-radius:14px; padding:12px 14px; font-weight:850; border:1px solid var(--stroke2); background: rgba(255,255,255,.08); color:var(--text);">
                  Сброс
                </button>
              </div>
            </div>

            <div class="deltas">
              <div class="deltaRow">
                <div class="label">Δ ДО ЛУЧШЕГО (ABS)</div>
                <div class="val" id="deltaAbs">—</div>
                <div class="posSmall" id="deltaAbsSub">сравнение с абсолютным best (тест)</div>
              </div>

              <div class="deltaRow">
                <div class="label">Δ ДО МЕСТА ВПЕРЕДИ</div>
                <div class="val" id="deltaAhead">—</div>
                <div class="posSmall" id="deltaAheadSub">отставание до P-1 по best lap</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT 1/3 -->
      <div class="panel">
        <div class="panelHead">
          <div class="h">Мои круги</div>
          <div class="hint">последние сверху</div>
        </div>
        <div class="panelBody" style="padding:10px;">
          <div class="lapsList" id="lapsList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== helpers =====
    const $ = (id) => document.getElementById(id);

    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatMMSS(totalSeconds){
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return `${pad2(m)}:${pad2(s)}`;
    }
    function toFixed3(x){
      return (Math.round(x * 1000) / 1000).toFixed(3);
    }
    function deltaLabel(delta){
      const sign = delta > 0 ? "+" : (delta < 0 ? "−" : "");
      return sign + toFixed3(Math.abs(delta));
    }
    function randLap(){
      // 31.800..33.200
      const v = 31.8 + Math.random() * 1.4;
      return Number(toFixed3(v));
    }

    // ===== state =====
    let sessionSeconds = 0;
    let kart = 14;
    let status = "Едет";

    let laps = []; // {n, time}
    let myBest = null;
    let myLast = null;

    // тестовые соперники (их best-lap обновляем редко, чтобы “жили”)
    const rivals = [
      { name:"P1", best: 32.210 },
      { name:"P2", best: 32.330 },
      { name:"P3", best: 32.480 },
      { name:"P4", best: 32.620 },
      { name:"P5", best: 32.860 },
      { name:"P6", best: 33.050 },
    ];

    function maybeUpdateRivals(){
      // слегка шевелим 1-2 соперника
      if (Math.random() < 0.35){
        const idx = Math.floor(Math.random()*rivals.length);
        const tweak = (Math.random()-0.5)*0.10; // +/-0.05
        rivals[idx].best = Number(toFixed3(Math.max(31.7, rivals[idx].best + tweak)));
      }
      if (Math.random() < 0.18){
        const idx = Math.floor(Math.random()*rivals.length);
        const improve = -Math.random()*0.08; // иногда улучшение
        rivals[idx].best = Number(toFixed3(Math.max(31.7, rivals[idx].best + improve)));
      }
    }

    function computeRanking(){
      const me = myBest ?? 999;
      const all = rivals.map(r => r.best).concat([me]).sort((a,b)=>a-b);
      const pos = all.indexOf(me) + 1; // 1..N
      const absBest = all[0];
      const aheadBest = pos > 1 ? all[pos-2] : null;

      return { pos, total: all.length, absBest, aheadBest };
    }

    // ===== render =====
    function renderTop(){
      $("kartNum").textContent = kart;
      $("statusText").textContent = status;
      $("sessionTime").textContent = formatMMSS(sessionSeconds);
      $("lapsCount").textContent = String(laps.length);
    }

    function setPill(el, text, kind){
      el.textContent = text;
      el.classList.remove("purple","good","bad");
      if (kind) el.classList.add(kind);
    }

    function renderSummary(){
      // last/best
      $("lastLap").textContent = myLast == null ? "—" : toFixed3(myLast);
      $("bestLap").textContent = myBest == null ? "—" : toFixed3(myBest);

      // пурпур: если last == best (твой лучший) — last тоже пурпурный
      $("lastLap").classList.remove("purple");
      if (myLast != null && myBest != null && myLast === myBest){
        $("lastLap").classList.add("purple");
        $("bestLap").classList.add("purple");
        setPill($("lastTag"), "BEST", "purple");
      } else {
        setPill($("lastTag"), myLast == null ? "—" : "OK", myLast == null ? "" : "");
      }

      // позиция / дельты
      const { pos, total, absBest, aheadBest } = computeRanking();

      $("posText").textContent = (myBest == null) ? "—" : `${pos}/${total}`;
      $("posSub").textContent = (myBest == null)
        ? "добавь круг кнопкой +Круг"
        : "позиция по лучшему кругу (best lap)";

      if (myBest == null){
        $("deltaAbs").textContent = "—";
        $("deltaAhead").textContent = "—";
        $("deltaAbsSub").textContent = " ";
        $("deltaAheadSub").textContent = " ";
        setPill($("deltaToBestPill"), "Δ к best: —", "");
        return;
      }

      const dAbs = myBest - absBest;
      const dAhead = aheadBest == null ? 0 : (myBest - aheadBest);

      $("deltaAbs").textContent = deltaLabel(dAbs);
      $("deltaAhead").textContent = aheadBest == null ? "0.000" : deltaLabel(dAhead);

      // цвет дельт
      $("deltaAbs").style.color = dAbs <= 0 ? "rgba(74,222,128,.95)" : "rgba(251,113,133,.95)";
      $("deltaAhead").style.color = (aheadBest == null || dAhead <= 0) ? "rgba(74,222,128,.95)" : "rgba(251,113,133,.95)";

      $("deltaAbsSub").textContent = `ABS best: ${toFixed3(absBest)}`;
      $("deltaAheadSub").textContent = aheadBest == null ? "ты лидер" : `впереди: ${toFixed3(aheadBest)}`;

      // Δ к best (в карточке last)
      const dToBest = myLast == null ? null : (myLast - myBest);
      if (dToBest == null){
        setPill($("deltaToBestPill"), "Δ к best: —", "");
      } else {
        const txt = `Δ к best: ${deltaLabel(dToBest)}`;
        // если last == best => пурпур
        if (myLast === myBest) setPill($("deltaToBestPill"), txt, "purple");
        else setPill($("deltaToBestPill"), txt, dToBest <= 0 ? "good" : "bad");
      }
    }

    function renderLaps(){
      const box = $("lapsList");
      box.innerHTML = "";

      const items = laps.slice().reverse(); // последние сверху
      items.forEach(l => {
        const isBest = (myBest != null && l.time === myBest);

        const div = document.createElement("div");
        div.className = "lapItem";

        div.innerHTML = `
          <div class="lapLeft">
            <div class="n">#${l.n}</div>
            <div class="t ${isBest ? 'purple' : ''}" style="${isBest ? 'color: var(--purple); font-weight:900;' : ''}">
              ${toFixed3(l.time)}
            </div>
          </div>
          <div class="lapRight">
            <span class="pill ${isBest ? 'purple' : ''}">${isBest ? 'BEST' : 'OK'}</span>
          </div>
        `;
        box.appendChild(div);
      });
    }

    // ===== actions =====
    function addLap(){
      maybeUpdateRivals();

      const time = randLap();
      const n = laps.length + 1;
      laps.push({ n, time });

      myLast = time;
      if (myBest == null) myBest = time;
      myBest = Math.min(myBest, time);

      renderTop();
      renderSummary();
      renderLaps();
    }

    function resetAll(){
      sessionSeconds = 0;
      laps = [];
      myBest = null;
      myLast = null;

      // чуть “сбросим” соперников к исходным
      rivals[0].best = 32.210;
      rivals[1].best = 32.330;
      rivals[2].best = 32.480;
      rivals[3].best = 32.620;
      rivals[4].best = 32.860;
      rivals[5].best = 33.050;

      renderTop();
      renderSummary();
      renderLaps();
    }

    // ===== init =====
    $("addLapBtn").addEventListener("click", addLap);
    $("resetBtn").addEventListener("click", resetAll);

    // старт
    renderTop();
    renderSummary();
    renderLaps();

    // таймер сессии
    setInterval(() => {
      sessionSeconds += 1;
      renderTop();
    }, 1000);

    // небольшой сид, чтобы сразу что-то было (можешь убрать, если не надо)
    // addLap(); addLap();
  </script>
</body>
</html>