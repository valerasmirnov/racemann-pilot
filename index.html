<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RaceMann Pilot — Debug</title>
  <style>
    :root{
      --bg1:#070816;
      --bg2:#0b0b1f;
      --card:#111226cc;
      --card2:#0f1022cc;
      --text:#e8e8ef;
      --muted:#a7a7b5;
      --stroke:#24254a;
      --accent:#b77bff;
      --good:#40d17a;
      --bad:#ff4d6d;
      --pill:#15163a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #2a1660 0%, rgba(42,22,96,0) 55%),
                  radial-gradient(900px 600px at 90% 10%, #1a2a66 0%, rgba(26,42,102,0) 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 60px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    h1{
      font-weight:700;
      font-size: 22px;
      margin:0;
      letter-spacing: .2px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(17,18,38,.55);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(8px);
      font-size: 14px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--bad);
      box-shadow: 0 0 0 3px rgba(255,77,109,.15);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 3px rgba(64,209,122,.15); }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(18,19,45,.55), rgba(12,13,28,.55));
      border-radius: 22px;
      padding: 16px;
      backdrop-filter: blur(10px);
      margin: 12px 0;
      overflow:hidden;
    }
    .card h2{
      margin:0 0 12px 0;
      font-size: 14px;
      letter-spacing: 4px;
      color: var(--muted);
      font-weight: 700;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 760px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .grid .wide{ grid-column: 1 / -1; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 6px 0 6px;
    }
    input{
      width:100%;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(10,10,28,.55);
      color: var(--text);
      padding: 14px 14px;
      font-size: 15px;
      outline:none;
    }
    input:focus{ border-color: rgba(183,123,255,.7); box-shadow: 0 0 0 3px rgba(183,123,255,.15); }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    button{
      border:1px solid var(--stroke);
      background: rgba(21,22,58,.55);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 15px;
      cursor:pointer;
    }
    button.primary{
      background: rgba(183,123,255,.22);
      border-color: rgba(183,123,255,.55);
    }
    button:active{ transform: translateY(1px); }

    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 8px 12px;
      align-items:start;
      margin-top: 10px;
    }
    .k{ color: var(--muted); font-size: 13px; }
    .v{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; word-break: break-all; }

    .liveRow{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (min-width: 760px){
      .liveRow{ grid-template-columns: 1fr 1fr; }
      .liveRow .wide{ grid-column: 1 / -1; }
    }

    .tile{
      border:1px solid var(--stroke);
      background: rgba(9,10,26,.45);
      border-radius: 22px;
      padding: 14px;
      min-height: 120px;
    }
    .tile .title{
      font-size: 12px;
      letter-spacing: 4px;
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 10px;
    }
    .big{
      font-size: 42px;
      font-weight: 800;
      letter-spacing: .5px;
      margin: 0;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(21,22,58,.5);
      color: var(--muted);
      font-size: 14px;
      white-space:nowrap;
    }
    .bar{
      height: 8px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(9,10,26,.6);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar > div{
      height:100%;
      width: 40%;
      background: var(--accent);
      opacity: .9;
      border-radius: 999px;
      transition: width .2s ease;
    }

    pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      color: #d7d7e6;
      background: rgba(7,8,20,.55);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 12px;
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      margin-top: 10px;
    }

    .muted{ color: var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1>RaceMann Pilot — Debug</h1>
      <div class="badge" id="healthBadge">
        <span class="dot" id="healthDot"></span>
        <span id="healthText">/health …</span>
      </div>
    </div>

    <div class="card">
      <h2>НАСТРОЙКИ</h2>
      <div class="grid">
        <div class="wide">
          <label>Worker API (не меняй, если всё ок)</label>
          <input id="apiBase" placeholder="https://racemann-api.vsmirnoff.workers.dev" />
        </div>

        <div class="wide">
          <label>Ссылка на заезд (RaceMann)</label>
          <input id="raceUrl" placeholder="https://miks.racemann.com/Race/id/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX#race" />
        </div>

        <div>
          <label>Номер карта (как в RaceMann: 05, 10, 19 и т.д.)</label>
          <input id="kart" placeholder="05" />
        </div>

        <div>
          <label>Период опроса, мс</label>
          <input id="pollMs" placeholder="1000" />
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btnShowId">Показать Race ID</button>
        <button id="btnHealth">Проверить /health</button>
        <button class="primary" id="btnStart">Старт</button>
        <button id="btnStop">Стоп</button>
      </div>

      <div class="kv">
        <div class="k">Race ID</div>
        <div class="v" id="raceIdOut">—</div>

        <div class="k">Normalized</div>
        <div class="v" id="normalizedOut">—</div>

        <div class="k">Kart</div>
        <div class="v" id="kartOut">—</div>
      </div>

      <div class="hint">
        Сейчас “Старт” будет опрашивать воркер и ждать JSON с временами.
        Если в воркере эндпоинт называется иначе — поправь константы <span class="muted">LIVE_PATH / REG_PATH</span> внизу.
      </div>
    </div>

    <div class="card">
      <h2>LIVE</h2>

      <div class="tile wide">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div class="title">STATUS</div>
          <div class="pill">
            <span class="dot" id="connDot"></span>
            <span id="connText">idle</span>
          </div>
        </div>
        <div class="bar"><div id="connBar"></div></div>
        <div class="sub">
          <span>poll: <span id="pollLabel">—</span> ms</span>
          <span>ts: <span id="tsLabel">—</span></span>
        </div>
      </div>

      <div class="liveRow">
        <div class="tile">
          <div class="title">LAST LAP</div>
          <div class="big" id="lastLap">—</div>
          <div class="sub">
            <span>Δ к best:</span>
            <span id="delta">—</span>
          </div>
        </div>

        <div class="tile">
          <div class="title">BEST LAP</div>
          <div class="big" id="bestLap">—</div>
          <div class="sub">
            <span>kart:</span>
            <span id="kartMini">—</span>
          </div>
        </div>

        <div class="tile wide">
          <div class="title">CURRENT LAP</div>
          <div class="big" id="currentLap">—</div>
          <div class="sub">
            <span>source:</span>
            <span id="sourceLabel">—</span>
          </div>
        </div>

        <div class="tile wide">
          <div class="title">DEBUG</div>
          <pre id="debugOut">{}</pre>
          <div class="hint" id="errLine"></div>
        </div>

        <div class="tile wide">
          <div class="title">REGISTRY (сырьё)</div>
          <pre id="registryOut">{}</pre>
        </div>
      </div>
    </div>
  </div>

<script>
  // ==== ENDPOINTS in your Worker ====
  const HEALTH_PATH = "/health";
  const LIVE_PATH   = "/live";
  const REG_PATH    = "/debug/registry";

  // ==== UI elements ====
  const els = {
    apiBase: document.getElementById("apiBase"),
    raceUrl: document.getElementById("raceUrl"),
    kart: document.getElementById("kart"),
    pollMs: document.getElementById("pollMs"),

    btnShowId: document.getElementById("btnShowId"),
    btnHealth: document.getElementById("btnHealth"),
    btnStart: document.getElementById("btnStart"),
    btnStop: document.getElementById("btnStop"),

    raceIdOut: document.getElementById("raceIdOut"),
    normalizedOut: document.getElementById("normalizedOut"),
    kartOut: document.getElementById("kartOut"),

    healthDot: document.getElementById("healthDot"),
    healthText: document.getElementById("healthText"),

    connDot: document.getElementById("connDot"),
    connText: document.getElementById("connText"),
    connBar: document.getElementById("connBar"),
    pollLabel: document.getElementById("pollLabel"),
    tsLabel: document.getElementById("tsLabel"),

    lastLap: document.getElementById("lastLap"),
    bestLap: document.getElementById("bestLap"),
    currentLap: document.getElementById("currentLap"),
    delta: document.getElementById("delta"),
    sourceLabel: document.getElementById("sourceLabel"),

    debugOut: document.getElementById("debugOut"),
    registryOut: document.getElementById("registryOut"),
    errLine: document.getElementById("errLine"),
    kartMini: document.getElementById("kartMini"),
  };

  // defaults
  els.apiBase.value = localStorage.getItem("apiBase") || "https://racemann-api.vsmirnoff.workers.dev";
  els.raceUrl.value = localStorage.getItem("raceUrl") || "";
  els.kart.value    = localStorage.getItem("kart")    || "";
  els.pollMs.value  = localStorage.getItem("pollMs")  || "1000";

  let timer = null;

  function saveState(){
    localStorage.setItem("apiBase", els.apiBase.value.trim());
    localStorage.setItem("raceUrl", els.raceUrl.value.trim());
    localStorage.setItem("kart", els.kart.value.trim());
    localStorage.setItem("pollMs", els.pollMs.value.trim());
  }

  function normalizeRaceUrl(input){
    try{
      const u = new URL(input.trim());
      u.hash = "";
      const m = u.pathname.match(/\/Race\/id\/([0-9a-fA-F-]{16,})/);
      if(!m) return { ok:false, error:"Race ID not found in URL" };
      const id = m[1];
      return { ok:true, raceId:id, normalized:`${u.origin}/Race/id/${id}` };
    }catch(e){
      return { ok:false, error:"Invalid URL" };
    }
  }

  function fmt(v){
    if(v === null || v === undefined) return "—";
    const n = Number(v);
    if(!Number.isFinite(n)) return String(v);
    const s = n.toFixed(3);
    // 65.123 -> 1:05.123 красиво, если хочешь:
    if(n >= 60){
      const mm = Math.floor(n/60);
      const ss = (n - mm*60).toFixed(3).padStart(6,"0");
      return `${mm}:${ss}`;
    }
    return s;
  }

  function setHealth(ok){
    if(ok){
      els.healthDot.classList.add("good");
      els.healthText.textContent = "/health ok";
    }else{
      els.healthDot.classList.remove("good");
      els.healthText.textContent = "/health error";
    }
  }

  function setConn(status){
    els.connText.textContent = status;
    if(status === "ok" || status === "stub"){
      els.connDot.classList.add("good");
      els.connBar.style.width = "70%";
    }else if(status === "no_data"){
      els.connDot.classList.add("good");
      els.connBar.style.width = "55%";
    }else if(status.includes("error")){
      els.connDot.classList.remove("good");
      els.connBar.style.width = "25%";
    }else{
      els.connDot.classList.remove("good");
      els.connBar.style.width = "35%";
    }
  }

  async function checkHealth(){
    saveState();
    const base = els.apiBase.value.trim().replace(/\/+$/,"");
    try{
      const r = await fetch(base + HEALTH_PATH, { cache:"no-store" });
      const j = await r.json();
      setHealth(!!j.ok);
      els.debugOut.textContent = JSON.stringify(j, null, 2);
      els.errLine.textContent = "";
    }catch(e){
      setHealth(false);
      els.errLine.textContent = "health err: " + String(e);
    }
  }

  function showRaceId(){
    saveState();
    const n = normalizeRaceUrl(els.raceUrl.value);
    if(!n.ok){
      els.raceIdOut.textContent = "—";
      els.normalizedOut.textContent = "—";
      els.errLine.textContent = n.error;
      return;
    }
    els.raceIdOut.textContent = n.raceId;
    els.normalizedOut.textContent = n.normalized;
    els.kartOut.textContent = (els.kart.value || "—").trim();
    els.kartMini.textContent = (els.kart.value || "—").trim();
    els.errLine.textContent = "";
  }

  async function pollOnce(){
    saveState();
    const base = els.apiBase.value.trim().replace(/\/+$/,"");
    const raceUrl = els.raceUrl.value.trim();
    const kart = els.kart.value.trim();
    const ms = Math.max(250, Number(els.pollMs.value || 1000));

    els.pollLabel.textContent = String(ms);

    // show id block always
    showRaceId();

    // LIVE
    const liveUrl = `${base}${LIVE_PATH}?raceUrl=${encodeURIComponent(raceUrl)}&kart=${encodeURIComponent(kart)}`;
    // REGISTRY (сырьё)
    const regUrl  = `${base}${REG_PATH}?raceUrl=${encodeURIComponent(raceUrl)}&kart=${encodeURIComponent(kart)}`;

    try{
      const r = await fetch(liveUrl, { cache:"no-store" });
      const j = await r.json();

      if(!r.ok){
        setConn("connection error");
        els.errLine.textContent = `HTTP ${r.status}: ${JSON.stringify(j)}`;
        els.debugOut.textContent = JSON.stringify({ error:`HTTP ${r.status}`, url: liveUrl, body:j }, null, 2);
        return;
      }

      // times
      els.lastLap.textContent = fmt(j.lastLap);
      els.bestLap.textContent = fmt(j.bestLap);
      els.currentLap.textContent = fmt(j.currentLapTime);
      els.delta.textContent = j.deltaBest === null ? "—" : fmt(j.deltaBest);

      els.sourceLabel.textContent = j.source || "—";
      els.tsLabel.textContent = j.ts ? String(j.ts) : "—";
      setConn(j.status || "ok");

      els.debugOut.textContent = JSON.stringify(j, null, 2);
      els.errLine.textContent = "";

    }catch(e){
      setConn("connection error");
      els.errLine.textContent = String(e);
      els.debugOut.textContent = JSON.stringify({ error:String(e), url: liveUrl }, null, 2);
    }

    // registry отдельно — чтобы даже при no_data понимать, что реально пришло
    try{
      const rr = await fetch(regUrl, { cache:"no-store" });
      const rj = await rr.json();
      els.registryOut.textContent = JSON.stringify(rj, null, 2);
    }catch(e){
      els.registryOut.textContent = JSON.stringify({ error:String(e), url: regUrl }, null, 2);
    }
  }

  function start(){
    stop();
    setConn("starting...");
    pollOnce();
    const ms = Math.max(250, Number(els.pollMs.value || 1000));
    timer = setInterval(pollOnce, ms);
  }

  function stop(){
    if(timer) clearInterval(timer);
    timer = null;
    setConn("stopped");
  }

  // wiring
  els.btnShowId.addEventListener("click", showRaceId);
  els.btnHealth.addEventListener("click", checkHealth);
  els.btnStart.addEventListener("click", start);
  els.btnStop.addEventListener("click", stop);

  // auto health on load
  checkHealth();
  showRaceId();
</script>
</body>
</html>