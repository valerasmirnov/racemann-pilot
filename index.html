<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RaceMann Pilot — RN экран (позиция / отставание / круги)</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background:#0b0c10; color:#e8e8ea;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 14px; }
    h1 { font-size: 18px; margin: 0 0 10px; font-weight: 800; }
    .muted { color:#9aa0a6; font-size: 13px; line-height: 1.35; }
    .card {
      border:1px solid #2a2f3a; border-radius: 16px; padding: 12px;
      background:#14161c; margin-top: 12px;
    }
    label { display:block; font-weight: 800; margin-bottom: 6px; font-size: 13px; color:#cfd3da; }
    input, select, button {
      font-size: 15px; padding: 10px 12px;
      border-radius: 14px; border: 1px solid #2a2f3a;
      background:#0f1116; color:#e8e8ea;
      box-sizing: border-box;
    }
    input { width: 100%; }
    button { cursor:pointer; font-weight: 900; background:#1f6feb; border-color:#1f6feb; }
    button.secondary { background:#0f1116; border-color:#2a2f3a; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: end; }
    .row > * { flex: 1 1 240px; }

    .kpis {
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (min-width: 720px) {
      .kpis { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    .kpi {
      border:1px solid #2a2f3a; border-radius: 16px;
      background:#0f1116; padding: 12px;
    }
    .kpi .t { color:#9aa0a6; font-size: 12px; font-weight: 800; margin-bottom: 6px; }
    .kpi .v { font-size: 26px; font-weight: 900; letter-spacing: -0.02em; }
    .kpi .s { margin-top: 6px; color:#9aa0a6; font-size: 12px; }

    .bigline {
      display:flex; gap:10px; flex-wrap: wrap; align-items: center;
      margin-top: 10px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid #2a2f3a;
      background:#0f1116;
    }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border:1px solid #2a2f3a; color:#9aa0a6; font-size: 12px;
    }
    .dot { width: 10px; height: 10px; border-radius: 999px; background:#666; display:inline-block; }
    .dot.ok { background:#26a269; }
    .dot.bad { background:#d13212; }
    pre {
      margin: 0; white-space: pre-wrap; word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      background:#0f1116; border:1px solid #2a2f3a; border-radius: 14px; padding: 10px;
      max-height: 28vh; overflow:auto;
    }
    .hint { margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RaceMann Pilot — экран по RN</h1>
    <div class="muted">
      Подключается к твоему Worker по WebSocket (<b>/ws</b>), слушает SignalR кадры и строит KPI по <b>RN</b>:
      <b>позиция</b>, <b>отставание от предшествующего</b>, <b>последний/лучший круг</b>.
    </div>

    <div class="card">
      <div class="row">
        <div style="flex: 3 1 420px;">
          <label>Worker WebSocket URL</label>
          <input id="workerWs" placeholder="wss://racemann-api.vsmirnoff.workers.dev/ws?raceUrl=...%23race&dropHb=1" />
          <div class="muted hint">Важно: в URL не должно быть “#”. Внутри raceUrl должно быть <b>%23race</b>.</div>
        </div>
        <div style="flex: 1 1 180px;">
          <label>RN (номер участника)</label>
          <input id="rn" inputmode="numeric" placeholder="например 1" />
        </div>
        <div style="flex: 1 1 180px;">
          <label>Показывать debug</label>
          <select id="debugMode">
            <option value="off">выкл</option>
            <option value="on">вкл</option>
          </select>
        </div>
        <div style="flex: 1 1 180px;">
          <label>&nbsp;</label>
          <div style="display:flex; gap:10px;">
            <button id="btnConnect">Connect</button>
            <button id="btnDisconnect" class="secondary" disabled>Disconnect</button>
          </div>
        </div>
      </div>

      <div class="bigline">
        <span class="pill"><span id="dot" class="dot bad"></span><b id="status">disconnected</b></span>
        <span class="pill">Frames: <b id="frames">0</b></span>
        <span class="pill">comp: <b id="compCount">0</b></span>
        <span class="pill">Last update: <b id="lastUpd">—</b></span>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="t">Позиция</div>
          <div id="kPos" class="v">—</div>
          <div class="s">pos</div>
        </div>
        <div class="kpi">
          <div class="t">Отставание до предшествующего</div>
          <div id="kGap" class="v">—</div>
          <div class="s">pld (abs)</div>
        </div>
        <div class="kpi">
          <div class="t">Последний круг</div>
          <div id="kLast" class="v">—</div>
          <div class="s">ll</div>
        </div>
        <div class="kpi">
          <div class="t">Лучший круг</div>
          <div id="kBest" class="v">—</div>
          <div class="s">bl</div>
        </div>
        <div class="kpi">
          <div class="t">Кругов / счётчик</div>
          <div id="kLc" class="v">—</div>
          <div class="s">lc</div>
        </div>
        <div class="kpi">
          <div class="t">RN</div>
          <div id="kRn" class="v">—</div>
          <div class="s">rn</div>
        </div>
        <div class="kpi">
          <div class="t">Карт</div>
          <div id="kCar" class="v">—</div>
          <div class="s">Car</div>
        </div>
        <div class="kpi">
          <div class="t">Пилот</div>
          <div id="kDrv" class="v" style="font-size:18px; line-height:1.15;">—</div>
          <div class="s">drv</div>
        </div>
      </div>
    </div>

    <div id="debugCard" class="card" style="display:none;">
      <label>Debug (последний comp для выбранного RN)</label>
      <pre id="debug"></pre>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ---------------- State ----------------
  let ws = null;
  let frames = 0;
  let compCount = 0;

  const state = {
    byRn: new Map(), // rn -> pilotState
    lastFrameAt: null
  };

  // ---------------- Helpers ----------------
  function setStatus(text, ok) {
    $("status").textContent = text;
    $("dot").classList.toggle("ok", !!ok);
    $("dot").classList.toggle("bad", !ok);
  }

  function updateHeader() {
    $("frames").textContent = String(frames);
    $("compCount").textContent = String(compCount);
    $("lastUpd").textContent = state.lastFrameAt ? new Date(state.lastFrameAt).toLocaleTimeString() : "—";
  }

  function safeJsonParse(s) {
    if (typeof s !== "string") return null;
    const t = s.trim();
    if (!t) return null;
    if (!(t.startsWith("{") || t.startsWith("["))) return null;
    try { return JSON.parse(t); } catch { return null; }
  }

  function msToLap(ms) {
    if (ms == null) return "—";
    const n = Number(ms);
    if (!Number.isFinite(n) || n <= 0) return "—";
    const totalMs = Math.round(n);
    const sec = Math.floor(totalMs / 1000);
    const msPart = String(totalMs % 1000).padStart(3, "0");
    const min = Math.floor(sec / 60);
    const secPart = String(sec % 60).padStart(2, "0");
    return `${min}:${secPart}.${msPart}`;
  }

  function msToGap(ms) {
    if (ms == null) return "—";
    const n = Number(ms);
    if (!Number.isFinite(n)) return "—";
    const abs = Math.abs(n);

    if (abs < 60000) return `+${(abs / 1000).toFixed(3)}s`;

    const totalMs = Math.round(abs);
    const sec = Math.floor(totalMs / 1000);
    const msPart = String(totalMs % 1000).padStart(3, "0");
    const min = Math.floor(sec / 60);
    const secPart = String(sec % 60).padStart(2, "0");
    return `+${min}:${secPart}.${msPart}`;
  }

  function renderSelected() {
    const rn = String($("rn").value.trim());
    $("kRn").textContent = rn || "—";

    if (!rn) {
      $("kPos").textContent = "—";
      $("kGap").textContent = "—";
      $("kLast").textContent = "—";
      $("kBest").textContent = "—";
      $("kLc").textContent = "—";
      $("kCar").textContent = "—";
      $("kDrv").textContent = "—";
      $("debug").textContent = "";
      return;
    }

    const p = state.byRn.get(rn);
    if (!p) {
      $("kPos").textContent = "—";
      $("kGap").textContent = "—";
      $("kLast").textContent = "—";
      $("kBest").textContent = "—";
      $("kLc").textContent = "—";
      $("kCar").textContent = "—";
      $("kDrv").textContent = "—";
      $("debug").textContent = "";
      return;
    }

    $("kPos").textContent = (p.position ?? "—");
    $("kGap").textContent = msToGap(p.gapPrevMs);
    $("kLast").textContent = msToLap(p.lastLapMs);
    $("kBest").textContent = msToLap(p.bestLapMs);
    $("kLc").textContent = (p.lapCount ?? "—");
    $("kCar").textContent = (p.car || "—");
    $("kDrv").textContent = (p.driver || "—");

    if ($("debugMode").value === "on") {
      $("debug").textContent = JSON.stringify(p.raw ?? {}, null, 2);
    } else {
      $("debug").textContent = "";
    }
  }

  function handleComp(cmd) {
    // cmd: { Time, Method:"Comp", Command:{...}, IsWideSpread }
    const method = (cmd?.Method || cmd?.method || "").toLowerCase();
    if (method !== "comp") return;

    const c = cmd.Command;
    if (!c || typeof c !== "object") return;

    const rn = String(c.rn ?? c.RN ?? "").trim();
    if (!rn) return;

    const prev = state.byRn.get(rn) || {};

    // gap to previous place:
    // primary: pld
    // fallback: pd.Time (если вдруг pld не будет)
    const gapPrevMs =
      (Number.isFinite(+c.pld) ? +c.pld : null) ??
      (Number.isFinite(+c.pd?.Time) ? +c.pd.Time : null) ??
      prev.gapPrevMs ?? null;

    const next = {
      rn,
      car: String(c.Car ?? prev.car ?? ""),
      driver: String(c.drv ?? prev.driver ?? ""),
      team: String(c.fn ?? prev.team ?? ""),

      position: Number.isFinite(+c.pos) ? +c.pos : (prev.position ?? null),
      lapCount: Number.isFinite(+c.lc) ? +c.lc : (prev.lapCount ?? null),

      lastLapMs: Number.isFinite(+c.ll) ? +c.ll : (prev.lastLapMs ?? null),
      bestLapMs: Number.isFinite(+c.bl) ? +c.bl : (prev.bestLapMs ?? null),

      gapPrevMs,
      updatedAt: Date.now(),
      raw: c
    };

    state.byRn.set(rn, next);
  }

  function extractRaceHubCommandsFromWorkerFrame(workerFrame) {
    // workerFrame: {type:"frame", C, M:[{H,M,A}, ...], raw}
    const out = [];
    const arr = Array.isArray(workerFrame?.M) ? workerFrame.M : [];
    for (const msg of arr) {
      if (!msg) continue;
      if (msg.H !== "RaceHub") continue;
      if (msg.M !== "newCommand") continue;

      const a0 = msg.A?.[0];
      if (!a0) continue;

      // a0 looks like: {Time, Method:"Comp", Command:{...}, IsWideSpread}
      out.push(a0);
    }
    return out;
  }

  // ---------------- Connection ----------------
  function connect() {
    const url = $("workerWs").value.trim();
    if (!url) { alert("Вставь Worker WebSocket URL"); return; }

    // reset counters, keep state (можно и сбрасывать state.byRn при желании)
    frames = 0;
    compCount = 0;
    state.lastFrameAt = null;
    updateHeader();
    renderSelected();

    disconnect();

    try {
      ws = new WebSocket(url);
    } catch (e) {
      alert("Не удалось создать WebSocket: " + e);
      return;
    }

    $("btnConnect").disabled = true;
    $("btnDisconnect").disabled = false;
    setStatus("connecting…", false);

    ws.addEventListener("open", () => {
      setStatus("connected", true);
    });

    ws.addEventListener("close", (e) => {
      setStatus(`closed (${e.code})`, false);
      $("btnConnect").disabled = false;
      $("btnDisconnect").disabled = true;
      ws = null;
    });

    ws.addEventListener("error", () => {
      setStatus("error", false);
    });

    ws.addEventListener("message", (evt) => {
      const text = typeof evt.data === "string" ? evt.data : "";
      const msg = safeJsonParse(text);
      if (!msg) return;

      if (msg.type && msg.type !== "frame") {
        // status frames from worker ignored for UI KPI
        return;
      }

      if (msg.type === "frame") {
        frames += 1;
        state.lastFrameAt = Date.now();

        const cmds = extractRaceHubCommandsFromWorkerFrame(msg);
        for (const cmd of cmds) {
          // We care about Comp for pilot KPI
          if ((cmd?.Method || "").toLowerCase() === "comp") {
            compCount += 1;
            handleComp(cmd);
          }
        }

        updateHeader();
        renderSelected();
      }
    });
  }

  function disconnect() {
    if (ws) {
      try { ws.close(1000, "bye"); } catch {}
      ws = null;
    }
    $("btnConnect").disabled = false;
    $("btnDisconnect").disabled = true;
    setStatus("disconnected", false);
  }

  // ---------------- UI wiring ----------------
  $("btnConnect").addEventListener("click", connect);
  $("btnDisconnect").addEventListener("click", disconnect);

  $("rn").addEventListener("input", renderSelected);
  $("debugMode").addEventListener("change", () => {
    $("debugCard").style.display = ($("debugMode").value === "on") ? "" : "none";
    renderSelected();
  });

  // Prefill (your worker base)
  if (!$("workerWs").value.trim()) {
    $("workerWs").value =
      "wss://racemann-api.vsmirnoff.workers.dev/ws?raceUrl=" +
      encodeURIComponent("https://miks.racemann.com/Race/id/f0bc4940-fa61-4bab-be0b-d9ee576238e2#race") +
      "&dropHb=1";
  }

  setStatus("disconnected", false);
  updateHeader();
  renderSelected();
})();
</script>
</body>
</html>
