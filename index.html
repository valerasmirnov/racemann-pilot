<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Racemann Pilot — Training</title>
  <style>
    :root{
      --bg0:#06080d;
      --bg1:#0b1220;
      --card:#0f1624cc;
      --stroke:#ffffff14;
      --text:#e9edf5;
      --muted:#9aa4b2;
      --purple:#b46cff;
      --red:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 20% -10%, #1a2a55 0%, transparent 55%),
        radial-gradient(900px 500px at 90% 15%, #2a1a55 0%, transparent 55%),
        radial-gradient(900px 700px at 50% 120%, #071a2b 0%, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
    }
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 14px 14px 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
    .grid{display:grid; gap:12px}
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, #121a2aee, #0c121fee);
      border-radius: 22px;
      padding: 18px 18px 16px;
      box-shadow:
        0 10px 30px #00000055,
        inset 0 1px 0 #ffffff10;
      backdrop-filter: blur(10px);
    }
    .label{
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted);
      opacity: .85;
    }
    .value{
      margin-top: 8px;
      font-size: 78px;
      line-height: 1;
      font-weight: 800;
      letter-spacing: -0.04em;
    }
    .value.purple{color: var(--purple)}
    .delta{
      margin-top: 10px;
      font-size: 20px;
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .delta .bad{ color: var(--red); font-weight: 700; }
    .delta .good{ color: #3ddc97; font-weight: 700; }
    .small{
      margin-top: 10px;
      font-size: 12px;
      color: #a7b0bf;
      opacity: .75;
      word-break: break-all;
    }
    .jsonbox{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      white-space: pre-wrap;
      line-height: 1.35;
      font-size: 12px;
      color: #c7d0df;
    }
    .footer{
      margin-top: 10px;
      font-size: 12px;
      color: #a7b0bf;
      opacity: .65;
      display:flex;
      justify-content: space-between;
      gap:10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card" id="lastCard">
        <div class="label">Last lap</div>
        <div class="value" id="lastLap">—</div>
        <div class="delta">
          <span>Δ</span>
          <span id="deltaBest" class="">—</span>
        </div>
      </div>

      <div class="card" id="bestCard">
        <div class="label">Best lap</div>
        <div class="value purple" id="bestLap">—</div>
      </div>

      <div class="card" id="currentCard">
        <div class="label">Current lap</div>
        <div class="value" id="currentLap">—</div>
      </div>

      <div class="card">
        <div class="label">Debug</div>
        <div class="jsonbox" id="rawJson">{}</div>
        <div class="footer">
          <span id="sourceLine">source: —</span>
          <span id="tsLine">ts: —</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://racemann-api.vsmirnoff.workers.dev/state";

    const elLast = document.getElementById("lastLap");
    const elBest = document.getElementById("bestLap");
    const elCur  = document.getElementById("currentLap");
    const elDelta = document.getElementById("deltaBest");
    const elRaw = document.getElementById("rawJson");
    const elTS = document.getElementById("tsLine");
    const elSource = document.getElementById("sourceLine");

    function fmt(x){
      if (x === null || x === undefined || Number.isNaN(x)) return "—";
      const n = Number(x);
      return n.toFixed(3);
    }

    function updateUI(data){
      const last = Number(data.lastLap);
      const best = Number(data.bestLap);
      const cur  = Number(data.currentLapTime);

      elLast.textContent = fmt(last);
      elBest.textContent = fmt(best);
      elCur.textContent  = fmt(cur);

      // Δ к best (только если оба есть)
      if (Number.isFinite(last) && Number.isFinite(best)) {
        const d = last - best;
        const sign = d >= 0 ? "+" : "−";
        const abs = Math.abs(d).toFixed(3);
        elDelta.textContent = `${sign}${abs}`;
        elDelta.className = d <= 0 ? "good" : "bad";
      } else {
        elDelta.textContent = "—";
        elDelta.className = "";
      }

      elRaw.textContent = JSON.stringify(data, null, 2);
      elTS.textContent = `ts: ${data.ts ?? "—"}`;
      elSource.textContent = `source: api`;
    }

    async function tick(){
      try{
        const r = await fetch(API_URL, { cache: "no-store" });
        const data = await r.json();
        updateUI(data);
      } catch (e){
        elSource.textContent = "source: error";
      }
    }

    tick();
    setInterval(tick, 1000);
  </script>
</body>
</html>