<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RaceMann Pilot — Debug</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; background:#070711; color:#e9e9f2; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px 14px 60px; }
    h1 { margin: 8px 0 14px; font-size: 22px; font-weight: 650; letter-spacing:.2px; }
    .card { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.08); border-radius: 18px; padding: 14px; backdrop-filter: blur(10px); }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 780px){ .grid { grid-template-columns: 1fr 1fr; } }
    label { font-size: 12px; opacity: .75; display:block; margin: 10px 0 6px; }
    input { width: 100%; box-sizing: border-box; padding: 12px 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.25); color: #fff; font-size: 14px; outline: none; }
    .row { display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
    button { padding: 12px 14px; border-radius: 14px; border: 1px solid rgba(255,255,255,.12); background: rgba(170,120,255,.22); color:#fff; font-weight: 650; cursor:pointer; }
    button.secondary { background: rgba(255,255,255,.06); }
    .pill { display:flex; align-items:center; gap:8px; padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.06); }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #888; }
    .dot.ok { background: #4be48b; }
    .dot.bad { background: #ff5c7a; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; line-height: 1.35; white-space: pre-wrap; word-break: break-word; }
    .kv { display:grid; grid-template-columns: 120px 1fr; gap: 8px 12px; }
    .kv div { padding: 2px 0; }
    .muted { opacity: .72; }
    .big { font-size: 28px; font-weight: 800; letter-spacing:.5px; }
    .small { font-size: 12px; opacity: .7; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RaceMann Pilot — Debug</h1>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <div class="muted">Настройки</div>
        <div class="pill"><span class="dot" id="healthDot"></span><span id="healthText">/health …</span></div>
      </div>

      <label>Worker API (не меняй, если всё ок)</label>
      <input id="api" value="https://racemann-api.vsmirnoff.workers.dev" />

      <label>Ссылка на заезд (RaceMann)</label>
      <input id="raceUrl" placeholder="https://miks.racemann.com/Race/id/....#race" />

      <label>Номер карта (как в RaceMann: 05, 10, 19 и т.д.)</label>
      <input id="kart" placeholder="77" />

      <label>Период опроса, мс</label>
      <input id="pollMs" value="1000" />

      <div class="row">
        <button id="btnShowId">Показать Race ID</button>
        <button id="btnStart">Старт (debug/all)</button>
        <button id="btnStop" class="secondary">Стоп</button>
        <button id="btnHealth" class="secondary">Проверить /health</button>
      </div>

      <div style="margin-top:12px" class="kv">
        <div class="muted">Race ID</div><div id="raceIdOut">—</div>
        <div class="muted">Normalized</div><div id="normalizedOut" class="mono">—</div>
        <div class="muted">Kart</div><div id="kartOut">—</div>
      </div>

      <div class="muted" style="margin-top:10px;font-size:12px;">
        Сейчас “Старт” будет звать воркер <b>/debug/all</b> и показывать:
        <b>raw</b> (оба connect payload), <b>allMessages</b>, <b>kartsSeen</b>, <b>foundForKart</b>.
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="grid">
      <div class="card">
        <div class="muted" style="display:flex;justify-content:space-between;align-items:center;">
          <div>LIVE</div>
          <div class="pill"><span class="dot" id="liveDot"></span><span id="liveText">stopped</span></div>
        </div>

        <div style="display:grid;grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;">
          <div class="card" style="padding:12px;">
            <div class="muted small">LAST LAP</div>
            <div class="big" id="lastLap">—</div>
            <div class="small">Δ к best: <span id="delta">—</span></div>
          </div>
          <div class="card" style="padding:12px;">
            <div class="muted small">BEST LAP</div>
            <div class="big" id="bestLap">—</div>
            <div class="small">kart: <span id="kartMini">—</span></div>
          </div>
        </div>

        <div class="card" style="padding:12px; margin-top:12px;">
          <div class="muted small">CURRENT / RAW STATUS</div>
          <div class="big" id="statusLine">—</div>
          <div class="small">poll: <span id="pollInfo">—</span> • ts: <span id="tsInfo">—</span></div>
        </div>
      </div>

      <div class="card">
        <div class="muted">DEBUG (ответ /debug/all)</div>
        <pre class="mono" id="debugOut" style="margin:10px 0 0;">—</pre>
      </div>
    </div>
  </div>

<script>
  const els = {
    api: document.getElementById('api'),
    raceUrl: document.getElementById('raceUrl'),
    kart: document.getElementById('kart'),
    pollMs: document.getElementById('pollMs'),

    btnShowId: document.getElementById('btnShowId'),
    btnStart: document.getElementById('btnStart'),
    btnStop: document.getElementById('btnStop'),
    btnHealth: document.getElementById('btnHealth'),

    raceIdOut: document.getElementById('raceIdOut'),
    normalizedOut: document.getElementById('normalizedOut'),
    kartOut: document.getElementById('kartOut'),

    healthDot: document.getElementById('healthDot'),
    healthText: document.getElementById('healthText'),

    liveDot: document.getElementById('liveDot'),
    liveText: document.getElementById('liveText'),

    lastLap: document.getElementById('lastLap'),
    bestLap: document.getElementById('bestLap'),
    delta: document.getElementById('delta'),
    kartMini: document.getElementById('kartMini'),

    statusLine: document.getElementById('statusLine'),
    pollInfo: document.getElementById('pollInfo'),
    tsInfo: document.getElementById('tsInfo'),

    debugOut: document.getElementById('debugOut'),
  };

  let timer = null;

  function normalizeRaceUrl(s){
    s = (s || '').trim().replace(/^"+|"+$/g,'');
    s = s.replace(/#.*$/, '');
    return s;
  }
  function extractRaceId(s){
    const m = (s||'').match(/\/Race\/id\/([0-9a-f\-]{36})/i);
    return m ? m[1] : '';
  }

  function fmtMs(ms){
    if (ms == null) return '—';
    const v = Number(ms);
    if (!Number.isFinite(v) || v <= 0) return '—';
    const sec = v/1000;
    const m = Math.floor(sec/60);
    const s = sec - m*60;
    return m > 0 ? `${m}:${s.toFixed(3).padStart(6,'0')}` : s.toFixed(3);
  }

  function setHealth(ok, text){
    els.healthDot.className = 'dot ' + (ok ? 'ok' : 'bad');
    els.healthText.textContent = text;
  }
  function setLive(status){
    const ok = status === 'ok';
    const bad = status === 'signalr_error' || status === 'worker_error';
    els.liveDot.className = 'dot ' + (ok ? 'ok' : bad ? 'bad' : '');
    els.liveText.textContent = status || '—';
  }

  async function health(){
    try{
      const api = els.api.value.trim().replace(/\/$/,'');
      const r = await fetch(api + '/health');
      const j = await r.json();
      setHealth(true, '/health ok');
      return j;
    }catch(e){
      setHealth(false, '/health fail');
      return null;
    }
  }

  function showRaceId(){
    const n = normalizeRaceUrl(els.raceUrl.value);
    const id = extractRaceId(n);
    els.raceIdOut.textContent = id || '—';
    els.normalizedOut.textContent = n || '—';
    els.kartOut.textContent = els.kart.value.trim() || '—';
    els.kartMini.textContent = els.kart.value.trim() || '—';
  }

  async function pollOnce(){
    const api = els.api.value.trim().replace(/\/$/,'');
    const raceUrl = encodeURIComponent(els.raceUrl.value.trim());
    const kart = encodeURIComponent(els.kart.value.trim());
    const url = `${api}/debug/all?raceUrl=${raceUrl}&kart=${kart}`;

    els.pollInfo.textContent = `${Math.max(250, Number(els.pollMs.value)||1000)} ms`;
    try{
      const r = await fetch(url);
      const j = await r.json();

      setLive(j.status || (j.ok ? 'ok' : 'error'));
      els.tsInfo.textContent = j.ts ? String(j.ts) : '—';
      els.statusLine.textContent = j.status || '—';

      // Пытаемся показать времена если parsed есть
      const parsed = j.parsed || null;
      if (parsed && (parsed.lastLap_ms || parsed.bestLap_ms)) {
        els.lastLap.textContent = fmtMs(parsed.lastLap_ms);
        els.bestLap.textContent = fmtMs(parsed.bestLap_ms);
        if (parsed.lastLap_ms && parsed.bestLap_ms) {
          const d = Number(parsed.lastLap_ms) - Number(parsed.bestLap_ms);
          els.delta.textContent = (Number.isFinite(d) ? (d>=0?'+':'') + fmtMs(Math.abs(d)* (d<0?-1:1)).replace(/^0:/,'') : '—');
        } else {
          els.delta.textContent = '—';
        }
      } else {
        els.lastLap.textContent = '—';
        els.bestLap.textContent = '—';
        els.delta.textContent = '—';
      }

      els.debugOut.textContent = JSON.stringify(j, null, 2);
    }catch(e){
      setLive('connection error');
      els.debugOut.textContent = JSON.stringify({ error: String(e), url }, null, 2);
    }
  }

  function start(){
    stop();
    showRaceId();
    setLive('starting…');
    pollOnce();
    const ms = Math.max(250, Number(els.pollMs.value)||1000);
    timer = setInterval(pollOnce, ms);
  }

  function stop(){
    if (timer) clearInterval(timer);
    timer = null;
    setLive('stopped');
  }

  els.btnShowId.addEventListener('click', showRaceId);
  els.btnStart.addEventListener('click', start);
  els.btnStop.addEventListener('click', stop);
  els.btnHealth.addEventListener('click', health);

  // авто
  showRaceId();
  health();
</script>
</body>
</html>