<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Racemann Pilot — Live</title>
  <style>
    :root{
      --bg1:#05070b;
      --bg2:#0a1020;
      --card:#0f1624cc;
      --stroke:#ffffff14;
      --text:#e9eefc;
      --muted:#aab3c6;
      --purple:#b46cff;
      --green:#35d07f;
      --red:#ff5a7a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% -10%, #1a2b60 0%, transparent 55%),
        radial-gradient(800px 700px at 90% 10%, #2a1450 0%, transparent 55%),
        linear-gradient(180deg,var(--bg2),var(--bg1));
      min-height:100vh;
    }
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:16px 14px 24px;
      padding-top: max(16px, env(safe-area-inset-top));
      padding-bottom: max(24px, env(safe-area-inset-bottom));
    }
    .card{
      background: linear-gradient(180deg, #0f1727cc, #0b1220cc);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:18px 18px 16px;
      box-shadow: 0 12px 50px #00000066;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin-bottom:14px;
    }
    .label{
      font-size:12px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color:var(--muted);
      opacity:.9;
    }
    .value{
      margin-top:8px;
      font-weight:800;
      font-size: clamp(44px, 9vw, 84px);
      line-height:1;
    }
    .value.purple{ color: var(--purple); }
    .sub{
      margin-top:10px;
      color:var(--muted);
      font-size:16px;
    }
    .sub .delta{ font-weight:700; margin-left:8px; }
    .delta.pos{ color:var(--red); }
    .delta.neg{ color:var(--green); }

    .debug{
      margin-top:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      color:#cfe3ffcc;
      white-space: pre-wrap;
      word-break: break-word;
      opacity:.9;
    }
    .tiny{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      margin-top:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#0b1220aa;
      font-size:13px;
      color:var(--muted);
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
    }
    .title{
      font-size:18px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background:var(--red);
      box-shadow:0 0 0 3px #ff5a7a22;
    }
    .dot.ok{
      background:var(--green);
      box-shadow:0 0 0 3px #35d07f22;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="title">Live</div>
      <div class="pill"><span id="dot" class="dot"></span><span id="statusText">нет связи</span></div>
    </div>

    <div class="card">
      <div class="label">LAST LAP</div>
      <div id="lastLap" class="value">—</div>
      <div class="sub">Δ к best: <span id="deltaBest" class="delta">—</span></div>
    </div>

    <div class="card">
      <div class="label">BEST LAP</div>
      <div id="bestLap" class="value purple">—</div>
    </div>

    <div class="card">
      <div class="label">CURRENT LAP</div>
      <div id="currentLap" class="value">—</div>
      <div class="tiny">
        <div>poll: <span id="pollMs">—</span> ms</div>
        <div>ts: <span id="ts">—</span></div>
      </div>
    </div>

    <div class="card">
      <div class="label">DEBUG</div>
      <div class="debug" id="debug">{}</div>
      <div class="tiny">
        <div>source: <span id="source">—</span></div>
        <div>err: <span id="err">—</span></div>
      </div>
    </div>
  </div>

  <script>
    // === Настройка: твой Worker ===
    const API_BASE = "https://racemann-api.vsmirnoff.workers.dev";
    const STATE_URL = API_BASE + "/state";

    const $ = (id) => document.getElementById(id);

    function fmt(v){
      if (v === null || v === undefined) return "—";
      const n = Number(v);
      if (!Number.isFinite(n)) return "—";
      return n.toFixed(3);
    }

    function setDelta(el, delta){
      if (delta === null || delta === undefined) { el.textContent = "—"; el.className = "delta"; return; }
      const n = Number(delta);
      if (!Number.isFinite(n)) { el.textContent = "—"; el.className = "delta"; return; }
      const sign = n > 0 ? "+" : "";
      el.textContent = sign + n.toFixed(3);
      el.className = "delta " + (n > 0 ? "pos" : "neg");
    }

    let timer = null;

    async function tick(){
      const t0 = performance.now();
      $("source").textContent = "fetch";
      $("err").textContent = "—";

      try{
        const res = await fetch(STATE_URL, { cache: "no-store" });
        const ms = Math.round(performance.now() - t0);
        $("pollMs").textContent = ms;

        if (!res.ok){
          $("dot").classList.remove("ok");
          $("statusText").textContent = "ошибка " + res.status;
          $("err").textContent = "HTTP " + res.status;
          return;
        }

        const data = await res.json();

        // UI values
        $("currentLap").textContent = fmt(data.currentLapTime);
        $("lastLap").textContent = fmt(data.lastLap);
        $("bestLap").textContent = fmt(data.bestLap);

        // Δ to best
        if (data.lastLap != null && data.bestLap != null){
          const d = Number(data.lastLap) - Number(data.bestLap);
          setDelta($("deltaBest"), d);
        } else {
          setDelta($("deltaBest"), null);
        }

        // status pill
        $("dot").classList.add("ok");
        $("statusText").textContent = data.status || "ok";

        // ts
        $("ts").textContent = (data.ts ?? "—");

        // debug
        $("debug").textContent = JSON.stringify(data, null, 2);

      } catch (e){
        $("dot").classList.remove("ok");
        $("statusText").textContent = "нет связи";
        $("err").textContent = e?.message || String(e);
        $("pollMs").textContent = "—";
      }
    }

    function start(){
      if (timer) clearInterval(timer);
      tick(); // сразу
      timer = setInterval(tick, 1000);
    }

    document.addEventListener("visibilitychange", () => {
      // чтобы не жечь батарейку, когда вкладка не активна
      if (document.hidden){
        if (timer) clearInterval(timer);
        timer = null;
      } else {
        start();
      }
    });

    start();
  </script>
</body>
</html>