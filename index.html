<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RaceMann Pilot — Debug</title>
  <style>
    :root{
      --bg0:#070812;
      --bg1:#0b0e1f;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.60);
      --mut2:rgba(255,255,255,.42);
      --line:rgba(255,255,255,.10);
      --ok:#3ddc97;
      --bad:#ff5d6c;
      --vio:#b47cff;
      --white:#ffffff;
      --radius:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--txt);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(180,124,255,.22), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(61,220,151,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      padding: 20px 14px 40px;
    }

    .wrap{max-width:720px;margin:0 auto}
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .title{
      font-size:22px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--mut);
      font-size:13px;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--mut2);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .dot.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(61,220,151,.15)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,93,108,.15)}

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    .card + .card{margin-top:14px}

    .h{
      font-size:13px;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:var(--mut2);
      margin:0 0 12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    label{
      display:block;
      font-size:12px;
      color:var(--mut);
      margin: 2px 0 6px;
    }

    input{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
      color:var(--txt);
      outline:none;
      font-size:16px;
    }
    input::placeholder{color:rgba(255,255,255,.28)}
    input:focus{border-color: rgba(180,124,255,.45); box-shadow: 0 0 0 4px rgba(180,124,255,.10)}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row > *{flex:1 1 180px}

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    button{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color:var(--txt);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 15px;
      cursor: pointer;
      min-width: 160px;
    }
    button.primary{
      background: rgba(180,124,255,.20);
      border-color: rgba(180,124,255,.35);
    }
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.5; cursor:not-allowed}

    .liveGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:stretch;
    }
    .tile{
      border-radius: 22px;
      padding: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      min-height: 110px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .tile .k{
      font-size: 12px;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:var(--mut2);
    }
    .tile .v{
      font-size: 44px;
      line-height: 1;
      font-weight: 800;
      margin-top: 10px;
      letter-spacing: .02em;
    }
    .tile .sub{
      margin-top: 8px;
      display:flex;
      justify-content:space-between;
      color: var(--mut2);
      font-size: 12px;
    }

    .wide{
      grid-column: 1 / -1;
    }

    .bar{
      height:8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      margin-top: 6px;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 35%;
      background: var(--vio);
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      word-break: break-word;
      color: rgba(255,255,255,.78);
      font-size: 12.5px;
      line-height: 1.4;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
    }

    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 12px;
      align-items:start;
      color: var(--mut);
      font-size: 13px;
      margin-top: 8px;
    }
    .kv b{color: var(--mut2); font-weight:600}
    .mut{color:var(--mut2); font-size: 13px; margin-top: 8px}
    .small{font-size:12px;color:var(--mut2)}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="title">RaceMann Pilot — Debug</div>
    <div class="pill" id="healthPill">
      <span class="dot" id="healthDot"></span>
      <span id="healthText">/health — неизвестно</span>
    </div>
  </div>

  <div class="card">
    <div class="h">НАСТРОЙКИ</div>

    <div class="grid">
      <div>
        <label for="apiBase">Worker API (не меняй, если всё ок)</label>
        <input id="apiBase" placeholder="https://racemann-api.vsmirnoff.workers.dev" />
      </div>

      <div>
        <label for="raceUrl">Ссылка на заезд (RaceMann)</label>
        <input id="raceUrl" placeholder="https://miks.racemann.com/Race/id/....#race" />
      </div>

      <div class="row">
        <div>
          <label for="kart">Номер карта (как в RaceMann: 05, 10, 19 и т.д.)</label>
          <input id="kart" placeholder="05" />
        </div>
        <div>
          <label for="pollMs">Период опроса, мс</label>
          <input id="pollMs" placeholder="1000" inputmode="numeric" />
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnShowId">Показать Race ID</button>
        <button id="btnHealth">Проверить /health</button>
        <button class="primary" id="btnStart">Старт</button>
        <button id="btnStop">Стоп</button>
      </div>

      <div class="kv">
        <b>Race ID</b><div id="raceIdOut">—</div>
        <b>Normalized</b><div id="normalizedOut">—</div>
        <b>Kart</b><div id="kartOut">—</div>
      </div>

      <div class="mut">
        Сейчас “Старт” будет опрашивать воркер и ждать JSON с временами.
        Если у тебя в воркере эндпоинт называется иначе — поправь константу <b>LIVE_PATH</b> внизу.
      </div>
    </div>
  </div>

  <div class="card">
    <div class="h">LIVE</div>

    <div class="liveGrid">
      <div class="tile wide">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div class="k">STATUS</div>
          <div class="pill" style="margin:0">
            <span class="dot" id="connDot"></span>
            <span id="connText">stopped</span>
          </div>
        </div>
        <div class="bar"><i id="connBar"></i></div>
        <div class="sub">
          <span>poll: <span id="pollOut">—</span> ms</span>
          <span>ts: <span id="tsOut">—</span></span>
        </div>
      </div>

      <div class="tile">
        <div class="k">LAST LAP</div>
        <div class="v" id="lastLapOut">—</div>
        <div class="sub"><span>Δ к best:</span><span id="deltaOut">—</span></div>
      </div>

      <div class="tile">
        <div class="k">BEST LAP</div>
        <div class="v" id="bestLapOut" style="color:var(--vio)">—</div>
        <div class="sub"><span>kart:</span><span id="kartOut2">—</span></div>
      </div>

      <div class="tile wide">
        <div class="k">CURRENT LAP</div>
        <div class="v" id="curLapOut">—</div>
        <div class="sub"><span>source:</span><span id="sourceOut">—</span></div>
      </div>

      <div class="tile wide">
        <div class="k">DEBUG</div>
        <div class="mono" id="debugOut">{ }</div>
        <div class="small">err: <span id="errOut">—</span></div>
      </div>
    </div>
  </div>

</div>

<script>
/**
 * Настройка:
 * Воркер должен отвечать на:
 * - GET  {apiBase}/health
 * - GET  {apiBase}/live?raceUrl=...&kart=...
 *
 * Формат ожидаемого JSON от /live (минимум):
 * {
 *   "status": "running",
 *   "raceId": "...",           // опционально
 *   "kart": "05",              // опционально
 *   "lastLap": 43.701,         // сек (number или null)
 *   "bestLap": 43.051,         // сек (number или null)
 *   "currentLapTime": 12.345,  // сек (number)
 *   "deltaBest": 0.650,        // сек (number) опционально
 *   "ts": 176650...,           // timestamp
 *   "source": "signalr|fetch"  // опционально
 * }
 */

const LIVE_PATH = "/live";   // <-- если в воркере другой путь, поменяй тут
const HEALTH_PATH = "/health";

const els = {
  apiBase: document.getElementById("apiBase"),
  raceUrl: document.getElementById("raceUrl"),
  kart: document.getElementById("kart"),
  pollMs: document.getElementById("pollMs"),

  btnShowId: document.getElementById("btnShowId"),
  btnHealth: document.getElementById("btnHealth"),
  btnStart: document.getElementById("btnStart"),
  btnStop: document.getElementById("btnStop"),

  // outputs
  raceIdOut: document.getElementById("raceIdOut"),
  normalizedOut: document.getElementById("normalizedOut"),
  kartOut: document.getElementById("kartOut"),
  kartOut2: document.getElementById("kartOut2"),

  healthDot: document.getElementById("healthDot"),
  healthText: document.getElementById("healthText"),

  connDot: document.getElementById("connDot"),
  connText: document.getElementById("connText"),
  connBar: document.getElementById("connBar"),

  pollOut: document.getElementById("pollOut"),
  tsOut: document.getElementById("tsOut"),

  lastLapOut: document.getElementById("lastLapOut"),
  bestLapOut: document.getElementById("bestLapOut"),
  curLapOut: document.getElementById("curLapOut"),
  deltaOut: document.getElementById("deltaOut"),
  sourceOut: document.getElementById("sourceOut"),
  errOut: document.getElementById("errOut"),
  debugOut: document.getElementById("debugOut"),
};

let timer = null;

// defaults
(function initDefaults(){
  const saved = JSON.parse(localStorage.getItem("racemann_pilot_v1") || "{}");
  els.apiBase.value = saved.apiBase || "https://racemann-api.vsmirnoff.workers.dev";
  els.raceUrl.value = saved.raceUrl || "";
  els.kart.value = saved.kart || "";
  els.pollMs.value = saved.pollMs || "1000";
  els.pollOut.textContent = String(els.pollMs.value || "—");
})();

function saveState(){
  localStorage.setItem("racemann_pilot_v1", JSON.stringify({
    apiBase: els.apiBase.value.trim(),
    raceUrl: els.raceUrl.value.trim(),
    kart: els.kart.value.trim(),
    pollMs: els.pollMs.value.trim(),
  }));
}

function setHealth(ok, text){
  els.healthDot.classList.remove("ok","bad");
  if (ok === true) els.healthDot.classList.add("ok");
  if (ok === false) els.healthDot.classList.add("bad");
  els.healthText.textContent = text;
}

function setConn(text, ok=null){
  els.connText.textContent = text;
  els.connDot.classList.remove("ok","bad");
  if (ok === true) els.connDot.classList.add("ok");
  if (ok === false) els.connDot.classList.add("bad");

  // небольшая "анимация" полоски
  if (text.includes("error")) {
    els.connBar.style.width = "100%";
    els.connBar.style.opacity = "0.35";
  } else if (text.includes("starting") || text.includes("poll")) {
    els.connBar.style.width = "65%";
    els.connBar.style.opacity = "1";
  } else if (text.includes("stopped")) {
    els.connBar.style.width = "25%";
    els.connBar.style.opacity = "0.8";
  } else {
    els.connBar.style.width = "45%";
    els.connBar.style.opacity = "1";
  }
}

function fmt(v){
  if (v === null || v === undefined) return "—";
  const n = Number(v);
  if (!Number.isFinite(n) || n <= 0) return "—";
  return n.toFixed(3);
}

function extractRaceId(url) {
  if (!url) return null;
  const m = url.match(/Race\/id\/([a-f0-9-]{36})/i);
  return m ? m[1] : null;
}

function normalizedRaceUrl(url){
  const id = extractRaceId(url);
  return id ? `https://miks.racemann.com/Race/id/${id}` : null;
}

function showRaceId(){
  const ru = els.raceUrl.value.trim();
  const kart = els.kart.value.trim();

  const id = extractRaceId(ru);
  els.raceIdOut.textContent = id ?? "❌ не найден";

  const norm = normalizedRaceUrl(ru);
  els.normalizedOut.textContent = norm ?? "—";

  els.kartOut.textContent = kart || "—";
  els.kartOut2.textContent = kart || "—";

  saveState();
}

async function checkHealth(){
  saveState();
  const base = els.apiBase.value.trim().replace(/\/+$/,"");
  try{
    setHealth(null, "/health — проверяем...");
    const r = await fetch(base + HEALTH_PATH, { cache: "no-store" });
    const t = await r.text();
    if (!r.ok) throw new Error(`HTTP ${r.status}: ${t.slice(0,200)}`);
    setHealth(true, "/health ok");
  }catch(e){
    setHealth(false, "/health ошибка");
    els.errOut.textContent = String(e.message || e);
  }
}

function makeLiveUrl(){
  const base = els.apiBase.value.trim().replace(/\/+$/,"");
  const raceUrl = els.raceUrl.value.trim();
  const kart = els.kart.value.trim();
  const u = new URL(base + LIVE_PATH);
  u.searchParams.set("raceUrl", raceUrl);
  u.searchParams.set("kart", kart);
  return u.toString();
}

async function pollOnce(){
  const ms = Math.max(250, Number(els.pollMs.value || 1000));
  els.pollOut.textContent = String(ms);

  const liveUrl = makeLiveUrl();

  try{
    setConn("polling…", true);
    const r = await fetch(liveUrl, { cache: "no-store" });
    const text = await r.text();

    if (!r.ok) throw new Error(`HTTP ${r.status}: ${text.slice(0,300)}`);

    let j;
    try { j = JSON.parse(text); }
    catch { throw new Error("Invalid JSON from worker: " + text.slice(0,200)); }

    // times
    els.lastLapOut.textContent = fmt(j.lastLap);
    els.bestLapOut.textContent = fmt(j.bestLap);
    els.curLapOut.textContent = fmt(j.currentLapTime);

    // delta
    const d = (j.deltaBest !== undefined && j.deltaBest !== null) ? Number(j.deltaBest) : null;
    els.deltaOut.textContent = (d === null || !Number.isFinite(d)) ? "—" : (d >= 0 ? `+${d.toFixed(3)}` : d.toFixed(3));

    // ts / source
    els.tsOut.textContent = j.ts ?? "—";
    els.sourceOut.textContent = j.source ?? "—";
    els.errOut.textContent = "—";

    // if worker returns raceId/kart too — покажем
    if (j.raceId) els.raceIdOut.textContent = j.raceId;
    if (j.normalized) els.normalizedOut.textContent = j.normalized;
    if (j.kart) {
      els.kartOut.textContent = j.kart;
      els.kartOut2.textContent = j.kart;
    }

    setConn(j.status || "ok", true);
    els.debugOut.textContent = JSON.stringify(j, null, 2);
  }catch(e){
    setConn("connection error", false);
    els.errOut.textContent = String(e.message || e);
    els.debugOut.textContent = JSON.stringify({ error: String(e.message || e), url: makeLiveUrl() }, null, 2);
  }
}

function start(){
  saveState();
  stop();
  showRaceId();

  setConn("starting…", null);
  pollOnce(); // сразу
  const ms = Math.max(250, Number(els.pollMs.value || 1000));
  timer = setInterval(pollOnce, ms);
}

function stop(){
  if (timer) clearInterval(timer);
  timer = null;
  setConn("stopped", null);
}

els.btnShowId.addEventListener("click", showRaceId);
els.btnHealth.addEventListener("click", checkHealth);
els.btnStart.addEventListener("click", start);
els.btnStop.addEventListener("click", stop);

// auto: показать race id если уже введено
showRaceId();
</script>
</body>
</html>