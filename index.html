<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>RaceMann Pilot — Debug</title>
  <style>
    :root{
      --bg:#0b0c14;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --accent:#b48cff;
      --bad:#ff5a7a;
      --ok:#35d07f;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--sans);margin:0;}
    .wrap{max-width:820px;margin:0 auto;padding:24px 16px 60px;}
    h1{font-size:22px;margin:0 0 14px;}
    .row{display:grid;grid-template-columns:1fr;gap:12px;}
    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(180,140,255,.10), rgba(255,255,255,.03));
      border-radius:18px;
      padding:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    .label{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:6px 0;}
    input{
      width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid var(--stroke);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      font-size:15px;
      outline:none;
    }
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-size:15px;
      cursor:pointer;
    }
    button.primary{background:rgba(180,140,255,.25);border-color:rgba(180,140,255,.55)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:start}
    .kv .k{color:var(--muted)}
    .kv .v{word-break:break-word}
    pre{
      margin:0;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      color:var(--text);
      overflow:auto;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .statusline{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--stroke);background:rgba(0,0,0,.18);
      color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.mid{background:var(--accent)}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;flex:1}
    .bar > i{display:block;height:100%;width:60%;background:var(--accent)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RaceMann Pilot — Debug</h1>

    <div class="card">
      <div class="statusline">
        <div class="pill" id="healthPill"><span class="dot mid"></span><span id="healthText">/health …</span></div>
        <div class="muted">UI → Worker → SignalR</div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <div class="label">Worker API (не меняй, если всё ок)</div>
          <input id="apiBase" value="https://racemann-api.vsmirnoff.workers.dev"/>
        </div>

        <div>
          <div class="label">Ссылка на заезд (RaceMann)</div>
          <input id="raceUrl" placeholder="https://miks.racemann.com/Race/id/....#race"/>
        </div>

        <div class="grid2">
          <div>
            <div class="label">Номер карта (как в RaceMann: 05, 10, 19…)</div>
            <input id="kart" value="77"/>
          </div>
          <div>
            <div class="label">Период опроса, мс</div>
            <input id="pollMs" value="1000"/>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnShowId">Показать Race ID</button>
          <button class="primary" id="btnStartAll">Старт (debug/all)</button>
          <button id="btnRegistry">Registry (сырьё)</button>
          <button id="btnHealth">Проверить /health</button>
          <button id="btnStop">Стоп</button>
        </div>

        <div class="kv" style="margin-top:10px">
          <div class="k">Race ID</div><div class="v" id="raceIdOut">—</div>
          <div class="k">Normalized</div><div class="v" id="normOut">—</div>
          <div class="k">Kart</div><div class="v" id="kartOut">—</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="label">LIVE</div>
      <div class="statusline">
        <div class="pill"><span class="dot bad" id="connDot"></span><span id="connText">stopped</span></div>
        <div class="bar"><i id="bar"></i></div>
        <div class="muted">poll: <span id="pollOut">—</span> ms • ts: <span id="tsOut">—</span></div>
      </div>
      <div style="margin-top:12px" class="grid2">
        <div class="card" style="background:rgba(255,255,255,.03)">
          <div class="label">LAST LAP</div>
          <div style="font-size:34px" id="lastLap">—</div>
          <div class="muted" id="delta">Δ к best: —</div>
        </div>
        <div class="card" style="background:rgba(255,255,255,.03)">
          <div class="label">BEST LAP</div>
          <div style="font-size:34px" id="bestLap">—</div>
          <div class="muted">kart: <span id="kartLive">—</span></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;background:rgba(255,255,255,.03)">
        <div class="label">CURRENT LAP</div>
        <div style="font-size:34px" id="curLap">—</div>
        <div class="muted">source: <span id="sourceOut">—</span></div>
      </div>

      <div style="margin-top:12px">
        <div class="label">DEBUG</div>
        <pre id="debug">{}</pre>
      </div>

      <div style="margin-top:12px">
        <div class="label">REGISTRY (сырьё)</div>
        <pre id="registry">{}</pre>
      </div>
    </div>
  </div>

<script>
  const els = {
    apiBase: document.getElementById('apiBase'),
    raceUrl: document.getElementById('raceUrl'),
    kart: document.getElementById('kart'),
    pollMs: document.getElementById('pollMs'),

    btnShowId: document.getElementById('btnShowId'),
    btnStartAll: document.getElementById('btnStartAll'),
    btnRegistry: document.getElementById('btnRegistry'),
    btnHealth: document.getElementById('btnHealth'),
    btnStop: document.getElementById('btnStop'),

    raceIdOut: document.getElementById('raceIdOut'),
    normOut: document.getElementById('normOut'),
    kartOut: document.getElementById('kartOut'),

    connDot: document.getElementById('connDot'),
    connText: document.getElementById('connText'),
    pollOut: document.getElementById('pollOut'),
    tsOut: document.getElementById('tsOut'),
    bar: document.getElementById('bar'),

    lastLap: document.getElementById('lastLap'),
    bestLap: document.getElementById('bestLap'),
    curLap: document.getElementById('curLap'),
    delta: document.getElementById('delta'),
    kartLive: document.getElementById('kartLive'),
    sourceOut: document.getElementById('sourceOut'),

    debug: document.getElementById('debug'),
    registry: document.getElementById('registry'),

    healthPill: document.getElementById('healthPill'),
    healthText: document.getElementById('healthText'),
  };

  let timer = null;

  function extractRaceId(s){
    const m = String(s||'').match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i);
    return m ? m[0].toLowerCase() : null;
  }
  function normalizeRaceUrl(s){
    const id = extractRaceId(s);
    return id ? `https://miks.racemann.com/Race/id/${id}` : null;
  }

  function setConn(text, ok=null){
    els.connText.textContent = text;
    if (ok === true){ els.connDot.className = "dot ok"; }
    else if (ok === false){ els.connDot.className = "dot bad"; }
    else { els.connDot.className = "dot mid"; }
  }

  function fmt(v){
    if (v == null) return "—";
    if (typeof v === "number") return v.toFixed(3);
    return String(v);
  }

  function api(path){
    const base = els.apiBase.value.replace(/\/+$/,'');
    return base + path;
  }

  async function checkHealth(){
    try{
      const r = await fetch(api('/health'));
      const j = await r.json();
      els.healthText.textContent = r.ok ? "/health ok" : "/health error";
      els.healthPill.querySelector('.dot').className = "dot " + (r.ok ? "ok":"bad");
      els.debug.textContent = JSON.stringify(j, null, 2);
    }catch(e){
      els.healthText.textContent = "/health error";
      els.healthPill.querySelector('.dot').className = "dot bad";
      els.debug.textContent = JSON.stringify({error:String(e)}, null, 2);
    }
  }

  function showRaceId(){
    const id = extractRaceId(els.raceUrl.value);
    const norm = normalizeRaceUrl(els.raceUrl.value);
    els.raceIdOut.textContent = id || "—";
    els.normOut.textContent = norm || "—";
    els.kartOut.textContent = els.kart.value || "—";
    els.kartLive.textContent = els.kart.value || "—";
    return { id, norm };
  }

  async function fetchRegistry(){
    const { norm } = showRaceId();
    if (!norm) return;
    const u = api(`/debug/registry?raceUrl=${encodeURIComponent(els.raceUrl.value)}&kart=${encodeURIComponent(els.kart.value||'')}`);
    const r = await fetch(u);
    const j = await r.json();
    els.registry.textContent = JSON.stringify(j, null, 2);
  }

  async function pollAllOnce(){
    const { norm } = showRaceId();
    if (!norm) return;

    const u = api(`/debug/all?raceUrl=${encodeURIComponent(els.raceUrl.value)}&kart=${encodeURIComponent(els.kart.value||'')}`);
    const r = await fetch(u);
    const j = await r.json();

    els.tsOut.textContent = j.ts ?? "—";
    els.pollOut.textContent = els.pollMs.value || "—";

    if (r.ok && j.ok){
      setConn(j.status || "ok", j.status !== "signalr_error");
    }else{
      setConn("connection error", false);
    }

    els.sourceOut.textContent = j.source || "—";

    // Пока у нас цель — видеть ВСЕ, поэтому времена не парсим (они будут в raw/allMessages)
    els.lastLap.textContent = "—";
    els.bestLap.textContent = "—";
    els.curLap.textContent = "—";
    els.delta.textContent = "Δ к best: —";

    els.debug.textContent = JSON.stringify(j, null, 2);

    // registry snapshot
    await fetchRegistry();
  }

  function startAll(){
    stop();
    setConn("starting…", null);
    pollAllOnce();
    const ms = Math.max(250, Number(els.pollMs.value || 1000));
    timer = setInterval(pollAllOnce, ms);
  }

  function stop(){
    if (timer) clearInterval(timer);
    timer = null;
    setConn("stopped", false);
  }

  // wiring
  els.btnHealth.addEventListener('click', checkHealth);
  els.btnShowId.addEventListener('click', showRaceId);
  els.btnStartAll.addEventListener('click', startAll);
  els.btnRegistry.addEventListener('click', fetchRegistry);
  els.btnStop.addEventListener('click', stop);

  // auto
  checkHealth();
  showRaceId();
</script>
</body>
</html>