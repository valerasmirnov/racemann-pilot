<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>RaceMann Pilot — Debug</title>
  <style>
    :root{
      --bg:#070816;
      --card:#0e1028cc;
      --stroke:#2a2d4a;
      --txt:#e9eaf6;
      --muted:#a7a9c8;
      --accent:#b37bff;
      --good:#32d583;
      --bad:#ff5a6a;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 20% -10%, #2b2b7a55 0%, transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, #b37bff33 0%, transparent 55%),
                  var(--bg);
      color:var(--txt);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
    }
    .wrap{max-width:900px;margin:0 auto;padding:24px 16px 80px;}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    h1{font-size:22px;margin:0;font-weight:700;letter-spacing:.2px;}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border:1px solid var(--stroke);
      background: #0b0d20aa;border-radius:999px;
      color:var(--muted);font-size:14px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#6b7280;}
    .dot.good{background:var(--good);}
    .dot.bad{background:var(--bad);}

    .card{
      margin-top:14px;
      background: linear-gradient(180deg, #13163a99 0%, #0d102a99 100%);
      border:1px solid #2b2f55aa;
      border-radius:18px;
      padding:16px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media (min-width:860px){ .grid{grid-template-columns:1.2fr .8fr;} }

    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 8px;}
    input{
      width:100%;
      box-sizing:border-box;
      padding:14px 14px;
      border-radius:14px;
      background:#07081a;
      border:1px solid #2a2d4a;
      color:var(--txt);
      font-size:15px;
      outline:none;
    }
    input:focus{border-color:#6b5cffaa; box-shadow:0 0 0 3px #6b5cff22;}
    .row{display:grid;grid-template-columns:1fr;gap:12px;}
    @media (min-width:650px){ .row{grid-template-columns:1fr 1fr;} }

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{
      appearance:none;border:0;
      padding:12px 14px;border-radius:14px;
      background:#1a1d3f;border:1px solid #2a2d4a;
      color:var(--txt);font-size:15px;font-weight:600;
    }
    button.primary{background: #1b1340; border-color:#3a2c75;}
    button:active{transform:translateY(1px);}
    .hint{color:var(--muted);font-size:14px;line-height:1.35;margin:12px 0 0;}

    .kv{
      display:grid;grid-template-columns:160px 1fr;gap:8px 12px;
      margin-top:14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;
      color:#dfe1ff;
      opacity:.95;
    }
    .kv div:nth-child(odd){color:#aeb2e8;}
    .mono{
      white-space:pre-wrap;
      word-break:break-word;
      background:#07081a;
      border:1px solid #2a2d4a;
      border-radius:14px;
      padding:12px;
      font-size:12.5px;
      color:#d9dcff;
      line-height:1.35;
      max-height:360px;
      overflow:auto;
    }

    .liveGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    .tile{
      border:1px solid #2a2d4a;
      background:#07081a;
      border-radius:16px;
      padding:14px;
      min-height:92px;
    }
    .tile.big{grid-column:1 / -1; min-height:110px;}
    .tTitle{color:var(--muted);font-size:12px;letter-spacing:.18em;}
    .tValue{margin-top:10px;font-size:44px;font-weight:800;letter-spacing:.02em;}
    .tSub{margin-top:10px;color:var(--muted);font-size:14px;}
    .bar{
      height:10px;border-radius:999px;background:#13163a;border:1px solid #2a2d4a;
      overflow:hidden;margin-top:10px;
    }
    .bar > div{height:100%;width:60%;background:var(--accent);}
    .smallRow{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:10px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>RaceMann Pilot — Debug</h1>
      <div class="pill" id="healthPill"><span class="dot" id="healthDot"></span><span id="healthText">/health …</span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="color:var(--muted);letter-spacing:.2em;font-size:12px;margin-bottom:8px;">НАСТРОЙКИ</div>

        <label>Worker API (не меняй, если всё ок)</label>
        <input id="apiBase" value="https://racemann-api.vsmirnoff.workers.dev" />

        <label>Ссылка на заезд (RaceMann)</label>
        <input id="raceUrl" placeholder="https://miks.racemann.com/Race/id/....#race" />

        <div class="row">
          <div>
            <label>Номер карта (как в RaceMann: 05, 10, 19 и т.д.)</label>
            <input id="kart" value="05" />
          </div>
          <div>
            <label>Период опроса, мс</label>
            <input id="pollMs" value="1000" />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnShowId">Показать Race ID</button>
          <button id="btnHealth">Проверить /health</button>
          <button id="btnStart">Старт (LIVE)</button>
          <button id="btnStop">Стоп</button>
          <button id="btnRegistry">Показать реестр (сырьё)</button>
        </div>

        <div class="kv" style="margin-top:14px;">
          <div>Race ID</div><div id="raceIdOut">—</div>
          <div>Normalized</div><div id="normOut">—</div>
          <div>Kart</div><div id="kartOut">—</div>
        </div>

        <div class="hint">
          Теперь отладка делается прямо тут: нажми <b>“Показать реестр (сырьё)”</b> — увидишь,
          какие SignalR-сообщения реально приходят воркеру (и по каким “командам”).
        </div>
      </div>

      <div class="card">
        <div style="color:var(--muted);letter-spacing:.2em;font-size:12px;margin-bottom:8px;">LIVE</div>

        <div class="tile big">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div class="tTitle">STATUS</div>
            <div class="pill" style="padding:8px 10px;">
              <span class="dot" id="connDot"></span>
              <span id="connText">stopped</span>
            </div>
          </div>
          <div class="bar"><div id="connBar"></div></div>
          <div class="smallRow"><span>poll: <span id="pollOut">—</span> ms</span><span>ts: <span id="tsOut">—</span></span></div>
        </div>

        <div class="liveGrid">
          <div class="tile">
            <div class="tTitle">LAST LAP</div>
            <div class="tValue" id="lastLap">—</div>
            <div class="tSub">Δ к best: <span id="delta">—</span></div>
          </div>
          <div class="tile">
            <div class="tTitle">BEST LAP</div>
            <div class="tValue" id="bestLap" style="color:var(--accent);">—</div>
            <div class="tSub">kart: <span id="kartLive">—</span></div>
          </div>
          <div class="tile big">
            <div class="tTitle">CURRENT LAP</div>
            <div class="tValue" id="curLap">—</div>
            <div class="tSub">source: <span id="sourceOut">—</span></div>
          </div>
        </div>

        <div style="margin-top:12px;color:var(--muted);letter-spacing:.2em;font-size:12px;">DEBUG</div>
        <div class="mono" id="debugOut">{}</div>

        <div style="margin-top:12px;color:var(--muted);letter-spacing:.2em;font-size:12px;">REGISTRY (сырьё)</div>
        <div class="mono" id="registryOut">Нажми “Показать реестр (сырьё)”.</div>
      </div>
    </div>
  </div>

<script>
  const LIVE_PATH = "/live";            // основной эндпоинт времени
  const REGISTRY_PATH = "/debug/registry"; // новый: сырой реестр сообщений

  const els = {
    apiBase: document.getElementById("apiBase"),
    raceUrl: document.getElementById("raceUrl"),
    kart: document.getElementById("kart"),
    pollMs: document.getElementById("pollMs"),

    btnShowId: document.getElementById("btnShowId"),
    btnHealth: document.getElementById("btnHealth"),
    btnStart: document.getElementById("btnStart"),
    btnStop: document.getElementById("btnStop"),
    btnRegistry: document.getElementById("btnRegistry"),

    raceIdOut: document.getElementById("raceIdOut"),
    normOut: document.getElementById("normOut"),
    kartOut: document.getElementById("kartOut"),

    healthDot: document.getElementById("healthDot"),
    healthText: document.getElementById("healthText"),

    connDot: document.getElementById("connDot"),
    connText: document.getElementById("connText"),
    connBar: document.getElementById("connBar"),
    pollOut: document.getElementById("pollOut"),
    tsOut: document.getElementById("tsOut"),

    lastLap: document.getElementById("lastLap"),
    bestLap: document.getElementById("bestLap"),
    curLap: document.getElementById("curLap"),
    delta: document.getElementById("delta"),
    sourceOut: document.getElementById("sourceOut"),
    kartLive: document.getElementById("kartLive"),

    debugOut: document.getElementById("debugOut"),
    registryOut: document.getElementById("registryOut"),
  };

  let timer = null;

  function normalizeRaceUrl(raw){
    const s = String(raw || "").trim().replace(/#.*$/, "");
    const m = s.match(/([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})/);
    if(!m) return { ok:false, error:"Не нашёл Race ID в ссылке" };
    const raceId = m[1].toLowerCase();
    return {
      ok:true,
      raceId,
      normalized:`https://miks.racemann.com/Race/id/${raceId}`
    };
  }

  function setHealth(ok, text){
    els.healthText.textContent = text;
    els.healthDot.className = "dot " + (ok ? "good" : "bad");
  }
  function setConn(text){
    els.connText.textContent = text;
    els.connDot.className = "dot " + (text && text !== "connection error" ? "good" : "bad");
    els.connBar.style.width = (text && text !== "connection error") ? "60%" : "18%";
  }

  function fmt(v){
    if(v == null) return "—";
    const n = Number(v);
    if(!Number.isFinite(n)) return String(v);
    return n.toFixed(3);
  }

  function saveState(){
    localStorage.setItem("rm_apiBase", els.apiBase.value.trim());
    localStorage.setItem("rm_raceUrl", els.raceUrl.value.trim());
    localStorage.setItem("rm_kart", els.kart.value.trim());
    localStorage.setItem("rm_pollMs", els.pollMs.value.trim());
  }
  function loadState(){
    const a = localStorage.getItem("rm_apiBase"); if(a) els.apiBase.value = a;
    const r = localStorage.getItem("rm_raceUrl"); if(r) els.raceUrl.value = r;
    const k = localStorage.getItem("rm_kart"); if(k) els.kart.value = k;
    const p = localStorage.getItem("rm_pollMs"); if(p) els.pollMs.value = p;
  }

  async function checkHealth(){
    try{
      const base = els.apiBase.value.trim().replace(/\/+$/, "");
      const r = await fetch(base + "/health", { cache:"no-store" });
      if(!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      setHealth(true, "/health ok");
      els.debugOut.textContent = JSON.stringify(j, null, 2);
    }catch(e){
      setHealth(false, "/health error");
      els.debugOut.textContent = JSON.stringify({ error:String(e) }, null, 2);
    }
  }

  function showRaceId(){
    const kart = (els.kart.value || "").trim();
    const n = normalizeRaceUrl(els.raceUrl.value);
    if(!n.ok){
      els.raceIdOut.textContent = "—";
      els.normOut.textContent = "—";
      els.kartOut.textContent = kart || "—";
      els.debugOut.textContent = JSON.stringify(n, null, 2);
      return;
    }
    els.raceIdOut.textContent = n.raceId;
    els.normOut.textContent = n.normalized;
    els.kartOut.textContent = kart || "—";
    els.debugOut.textContent = JSON.stringify({ ok:true, ...n, kart }, null, 2);
  }

  async function fetchRegistry(){
    saveState();
    const base = els.apiBase.value.trim().replace(/\/+$/, "");
    const raceUrl = els.raceUrl.value.trim();
    const kart = els.kart.value.trim();

    const u = new URL(base + REGISTRY_PATH);
    u.searchParams.set("raceUrl", raceUrl);
    u.searchParams.set("kart", kart);

    els.registryOut.textContent = "loading…";

    try{
      const r = await fetch(u.toString(), { cache:"no-store" });
      const txt = await r.text();
      els.registryOut.textContent = txt;

      // ещё покажем в debugOut кратко
      els.debugOut.textContent = JSON.stringify({
        ok: r.ok,
        status: r.status,
        url: u.toString()
      }, null, 2);

      if(!r.ok) setConn("connection error");
      else setConn("registry ok");
    }catch(e){
      setConn("connection error");
      els.registryOut.textContent = JSON.stringify({ error:String(e) }, null, 2);
    }
  }

  async function pollOnce(){
    const base = els.apiBase.value.trim().replace(/\/+$/, "");
    const raceUrl = els.raceUrl.value.trim();
    const kart = els.kart.value.trim();
    const ms = Math.max(250, Number(els.pollMs.value || 1000));

    els.pollOut.textContent = String(ms);

    const u = new URL(base + LIVE_PATH);
    u.searchParams.set("raceUrl", raceUrl);
    u.searchParams.set("kart", kart);

    try{
      const r = await fetch(u.toString(), { cache:"no-store" });
      const j = await r.json();

      els.tsOut.textContent = j.ts ?? "—";
      els.kartLive.textContent = j.kart ?? kart ?? "—";

      els.lastLap.textContent = fmt(j.lastLap);
      els.bestLap.textContent = fmt(j.bestLap);
      els.curLap.textContent = fmt(j.currentLapTime);
      els.delta.textContent = fmt(j.deltaBest);
      els.sourceOut.textContent = j.source ?? "—";

      setConn(j.status || "ok");
      els.debugOut.textContent = JSON.stringify(j, null, 2);
    }catch(e){
      setConn("connection error");
      els.debugOut.textContent = JSON.stringify({ error:String(e), url: u.toString() }, null, 2);
    }
  }

  function start(){
    saveState();
    stop();
    showRaceId();
    setConn("starting…");
    pollOnce();
    const ms = Math.max(250, Number(els.pollMs.value || 1000));
    timer = setInterval(pollOnce, ms);
  }

  function stop(){
    if(timer) clearInterval(timer);
    timer = null;
    setConn("stopped");
  }

  loadState();
  checkHealth();

  els.btnShowId.addEventListener("click", showRaceId);
  els.btnHealth.addEventListener("click", checkHealth);
  els.btnStart.addEventListener("click", start);
  els.btnStop.addEventListener("click", stop);
  els.btnRegistry.addEventListener("click", fetchRegistry);
</script>
</body>
</html>