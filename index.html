<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RaceMann RAW messages</title>
  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#101010;
      --panel2:#141414;
      --text:#e9e9e9;
      --muted:#9aa0a6;
      --green:#34c759;
      --red:#ff453a;
      --blue:#0a84ff;
      --border:#242424;
    }
    html,body{height:100%; background:var(--bg); color:var(--text); margin:0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liber_toggle.ttf", "Courier New", monospace;}
    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 24px;}
    h1{margin:0 0 14px; font-size:20px; color:var(--green); letter-spacing:.4px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .spacer{height:10px}
    input[type="text"], input[type="number"]{
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      outline:none;
      width:min(680px, 100%);
      box-sizing:border-box;
    }
    input[type="number"]{width:120px}
    button{
      background:var(--panel2);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      user-select:none;
    }
    button.primary{background: #122016; border-color:#1f3a28; color:#c9ffd7}
    button.danger{background:#221111; border-color:#3a1f1f; color:#ffd0d0}
    button:disabled{opacity:.55; cursor:not-allowed}
    label{display:flex; align-items:center; gap:8px; color:var(--muted)}
    .meta{color:var(--muted); font-size:13px}
    .statusline{font-size:14px; margin-top:6px}
    .ok{color:var(--green)}
    .bad{color:var(--red)}
    .log{
      margin-top:12px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      height:52vh;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      line-height:1.35;
    }
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--muted);
      font-size:12px;
    }
    .kbd{background:#1b1b1b;border:1px solid #2c2c2c;padding:2px 6px;border-radius:7px;color:#ddd}
    .card{
      margin-top:10px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
    }
    .card h2{margin:0 0 8px; font-size:14px; color:#cfd7ff}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }
    .small{font-size:12px; color:var(--muted)}
    .mono{font-family:inherit}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RaceMann RAW messages</h1>

    <div class="row">
      <input id="raceUrl" type="text" placeholder="https://miks.racemann.com/Race/id/....#race" />
      <button id="startBtn" class="primary">START</button>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <button id="stopBtn" class="danger" disabled>STOP</button>
      <button id="downloadBtn" disabled>Download JSON</button>
      <label><input id="dropHb" type="checkbox" checked /> drop hb</label>
      <span class="pill">
        <span>frames: <b id="framesCnt">0</b></span>
        <span>|</span>
        <span>newCommand: <b id="newCmdCnt">0</b></span>
      </span>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <span class="meta">Kart</span>
      <input id="kart" type="number" value="72" min="0" step="1" />
      <button id="showKartBtn">Show kart</button>
      <span class="meta">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤ DevTools —ç—Ç–æ –ø–æ–ª–µ —á–∞—Å—Ç–æ = <span class="kbd">rn</span> –∏–ª–∏ <span class="kbd">nn</span></span>
    </div>

    <div class="statusline" id="statusLine"></div>

    <div class="card">
      <h2>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ –ø–æ –∫–∞—Ä—Ç—É</h2>
      <div class="small" id="kartInfo">‚Äî</div>
    </div>

    <div class="log" id="log"></div>

    <div class="small" style="margin-top:10px">
      Worker endpoint: <span class="mono" id="wsInfo">‚Äî</span>
    </div>
  </div>

<script>
(() => {
  // üîß –í–ê–ñ–ù–û: —Ç—É—Ç —Ç–≤–æ–π –¥–æ–º–µ–Ω –≤–æ—Ä–∫–µ—Ä–∞
  const WORKER_ORIGIN = "https://racemann-api.vsmirnoff.workers.dev";

  const el = (id) => document.getElementById(id);

  const raceUrlEl = el("raceUrl");
  const startBtn = el("startBtn");
  const stopBtn = el("stopBtn");
  const downloadBtn = el("downloadBtn");
  const dropHbEl = el("dropHb");
  const kartEl = el("kart");
  const showKartBtn = el("showKartBtn");
  const statusLine = el("statusLine");
  const logEl = el("log");
  const framesCntEl = el("framesCnt");
  const newCmdCntEl = el("newCmdCnt");
  const kartInfoEl = el("kartInfo");
  const wsInfoEl = el("wsInfo");

  // State
  let ws = null;
  let frames = [];        // –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ JSON-–ø–∞–∫–µ—Ç—ã (SignalR connect frames)
  let framesCount = 0;
  let newCommandCount = 0;

  // Helpers
  function setStatusOk(text){ statusLine.innerHTML = `<span class="ok">‚úÖ ${escapeHtml(text)}</span>`; }
  function setStatusBad(text){ statusLine.innerHTML = `<span class="bad">‚ùå ${escapeHtml(text)}</span>`; }
  function setStatusInfo(text){ statusLine.innerHTML = `<span class="meta">${escapeHtml(text)}</span>`; }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function logLine(line){
    const atBottom = (logEl.scrollTop + logEl.clientHeight + 40) >= logEl.scrollHeight;
    logEl.textContent += line + "\n";
    if (atBottom) logEl.scrollTop = logEl.scrollHeight;
  }

  function resetState(){
    frames = [];
    framesCount = 0;
    newCommandCount = 0;
    framesCntEl.textContent = "0";
    newCmdCntEl.textContent = "0";
    logEl.textContent = "";
    kartInfoEl.textContent = "‚Äî";
  }

  function makeWsUrl(raceUrl, dropHb){
    const u = new URL(WORKER_ORIGIN);
    u.protocol = (u.protocol === "https:") ? "wss:" : "ws:";
    u.pathname = "/ws";
    u.searchParams.set("raceUrl", raceUrl.replace("#race",""));
    u.searchParams.set("dropHb", dropHb ? "1" : "0");
    return u.toString();
  }

  function enableUi(connected){
    startBtn.disabled = connected;
    raceUrlEl.disabled = connected;
    dropHbEl.disabled = connected;
    stopBtn.disabled = !connected;
    downloadBtn.disabled = frames.length === 0;
  }

  function onFrame(obj){
    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    frames.push(obj);
    framesCount++;
    framesCntEl.textContent = String(framesCount);
    downloadBtn.disabled = frames.length === 0;

    // —Å—á–∏—Ç–∞–µ–º newCommand (–≤–Ω—É—Ç—Ä–∏ M –º–∞—Å—Å–∏–≤–∞)
    if (obj && Array.isArray(obj.M)) {
      for (const m of obj.M) {
        if (m && m.M === "newCommand") newCommandCount++;
      }
      newCmdCntEl.textContent = String(newCommandCount);
    }

    // –≤ –ª–æ–≥ –ø–µ—á–∞—Ç–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ (–ø–µ—Ä–≤—ã–µ 1-2 —Å—Ç—Ä–æ–∫–∏)
    if (obj && obj.type === "status") {
      logLine(`[status] ${obj.stage || ""} ${obj.raceId || ""}`.trim());
      return;
    }
    if (obj && obj.type === "error") {
      logLine(`[error] ${obj.stage} ${obj.status || ""} ${obj.body || ""}`.trim());
      return;
    }
    if (obj && obj.type === "fatal") {
      logLine(`[fatal] ${obj.error}`);
      return;
    }

    // –æ–±—ã—á–Ω—ã–π signalr connect payload: {C:"...", M:[...], S:1?}
    // –ø–µ—á–∞—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–∫–æ
    if (obj && obj.C) {
      const mc = Array.isArray(obj.M) ? obj.M.length : 0;
      logLine(`C=${obj.C} | M=${mc}`);
    } else {
      logLine(`frame ${framesCount}`);
    }
  }

  // --- Kart helper ---
  function findLastCompForKart(kartNum){
    // –ò—â–µ–º –≤ frames —Å –∫–æ–Ω—Ü–∞: message.M == newCommand –∏ A[0].Method == "Comp"
    // –ò —Å–æ–≤–ø–∞–¥–∞–µ—Ç rn/nn/fn –ø–æ –∫–∞—Ä—Ç–µ
    const k = String(kartNum);

    for (let i = frames.length - 1; i >= 0; i--) {
      const fr = frames[i];
      if (!fr || !Array.isArray(fr.M)) continue;

      for (let j = fr.M.length - 1; j >= 0; j--) {
        const hubMsg = fr.M[j];
        if (!hubMsg || hubMsg.M !== "newCommand" || !Array.isArray(hubMsg.A) || !hubMsg.A[0]) continue;

        const ev = hubMsg.A[0];
        if (ev.Method !== "Comp") continue;

        const cmd = ev.Command || {};
        // –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–∞
        const rn = (cmd.rn != null) ? String(cmd.rn) : "";
        const nn = (cmd.nn != null) ? String(cmd.nn) : "";
        const fn = (cmd.fn != null) ? String(cmd.fn) : "";

        if (rn === k || nn === k || fn.includes(k)) {
          return { frame: fr, msg: hubMsg, ev };
        }
      }
    }
    return null;
  }

  function msToLapStr(ms){
    if (!Number.isFinite(ms)) return "‚Äî";
    const s = ms / 1000;
    return s.toFixed(3);
  }

  function showKart(){
    const k = Number(kartEl.value || 0);
    if (!frames.length) {
      kartInfoEl.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (frames –ø—É—Å—Ç–æ–π). –°–Ω–∞—á–∞–ª–∞ START.";
      return;
    }
    const found = findLastCompForKart(k);
    if (!found) {
      kartInfoEl.textContent = `–ù–µ –Ω–∞—à—ë–ª Comp –ø–æ –∫–∞—Ä—Ç—É ${k} (–ø–æ–∫–∞). –ü–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –∏–ª–∏ —Å–Ω–∏–º–∏ drop hb.`;
      return;
    }

    const ev = found.ev;
    const cmd = ev.Command || {};
    const cs = cmd.cs || {};

    // –í–∞–∂–Ω–æ: RaceMann –æ—Ç–¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–∞ –≤ –ú–°
    const best = (cmd.bl != null) ? Number(cmd.bl) : (cs.bl != null ? Number(cs.bl) : NaN);
    const last = (cmd.ll != null) ? Number(cmd.ll) : (cs.ll != null ? Number(cs.ll) : NaN);
    const laps = (cmd.lc != null) ? Number(cmd.lc) : (cs.lc != null ? Number(cs.lc) : NaN);

    const pos = (cmd.pos != null) ? cmd.pos : "‚Äî";
    const name = cmd.fn || cs.fn || `kart ${k}`;
    const t = (cmd.pt != null) ? cmd.pt : (cs.t != null ? cs.t : "‚Äî");

    kartInfoEl.innerHTML =
      `<div><b>${escapeHtml(name)}</b></div>` +
      `<div class="small">pos: <b>${escapeHtml(pos)}</b> | laps: <b>${escapeHtml(laps)}</b> | t: ${escapeHtml(t)}</div>` +
      `<div class="small">best: <b>${escapeHtml(msToLapStr(best))}</b> | last: <b>${escapeHtml(msToLapStr(last))}</b></div>`;
  }

  // --- WebSocket controls ---
  function start(){
    const raceUrl = (raceUrlEl.value || "").trim();
    if (!raceUrl) { setStatusBad("–í—Å—Ç–∞–≤—å raceUrl"); return; }

    resetState();
    const wsUrl = makeWsUrl(raceUrl, dropHbEl.checked);
    wsInfoEl.textContent = wsUrl;

    setStatusInfo("Connecting...");
    enableUi(true);

    try {
      ws = new WebSocket(wsUrl);
    } catch (e) {
      setStatusBad("WebSocket create error: " + e);
      enableUi(false);
      return;
    }

    ws.onopen = () => {
      setStatusOk("connected");
      logLine("WS open");
    };

    ws.onmessage = (ev) => {
      let obj;
      try { obj = JSON.parse(ev.data); }
      catch {
        // –∏–Ω–æ–≥–¥–∞ worker –º–æ–∂–µ—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —Å—Ç—Ä–æ–∫—É
        logLine(String(ev.data));
        return;
      }
      onFrame(obj);
    };

    ws.onerror = () => {
      setStatusBad("ws error");
    };

    ws.onclose = (ev) => {
      setStatusBad(`closed (${ev.code})`);
      logLine(`WS closed code=${ev.code} reason=${ev.reason || ""}`.trim());
      enableUi(false);
      ws = null;
      // –∫–Ω–æ–ø–∫–∞ Download –æ—Å—Ç–∞—ë—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —É—Å–ø–µ–ª–∏ —Å–æ–±—Ä–∞—Ç—å
      downloadBtn.disabled = frames.length === 0;
    };
  }

  function stop(){
    if (ws) {
      try { ws.close(1000, "stop"); } catch {}
    }
  }

  function downloadJson(){
    const payload = {
      meta: {
        exportedAt: new Date().toISOString(),
        frames: framesCount,
        newCommand: newCommandCount,
        raceUrl: (raceUrlEl.value || "").trim(),
        dropHb: dropHbEl.checked
      },
      frames
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `racemann_messages_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 4000);
  }

  // UI events
  startBtn.addEventListener("click", start);
  stopBtn.addEventListener("click", stop);
  downloadBtn.addEventListener("click", downloadJson);
  showKartBtn.addEventListener("click", showKart);

  // —É–¥–æ–±–Ω–æ: Enter –≤ –ø–æ–ª–µ raceUrl
  raceUrlEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") start();
  });

  // initial
  enableUi(false);
  setStatusInfo("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –∑–∞–µ–∑–¥–∞ –∏ –Ω–∞–∂–º–∏ START");
  wsInfoEl.textContent = `${WORKER_ORIGIN.replace("https://","wss://")}/ws?raceUrl=...&dropHb=1`;

})();
</script>
</body>
</html>