<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RaceMann Live</title>
  <style>
    :root{
      --bg:#070A12;
      --card:#0E1422;
      --card2:#0B1020;
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.55);
      --accent:#A855F7;
      --ok:#22C55E;
      --bad:#EF4444;
      --border:rgba(255,255,255,.07);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(168,85,247,.18), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(59,130,246,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:20px 16px 40px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .title{
      font-size:28px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      font-size:13px;
      color:var(--muted);
      min-width:120px;
      justify-content:center;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.22);
      box-shadow:0 0 0 4px rgba(255,255,255,.05);
    }
    .dot.ok{ background: var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.16); }
    .dot.bad{ background: var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.16); }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:24px;
      padding:18px 18px 16px;
      margin:14px 0;
      box-shadow: 0 25px 55px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .label{
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:rgba(234,240,255,.45);
      margin-bottom:10px;
    }
    .big{
      font-size:76px;
      line-height:1;
      font-weight:800;
      letter-spacing:-.02em;
    }
    .big.accent{ color: var(--accent); }
    .smallrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:10px;
      color:var(--muted);
      font-size:14px;
    }
    .debug{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      color:rgba(234,240,255,.72);
      margin-top:10px;
    }

    .ctrls{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    input{
      flex:1;
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color: rgba(234,240,255,.35); }
    button{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.08);
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      user-select:none;
    }
    button.primary{
      background: rgba(168,85,247,.25);
      border-color: rgba(168,85,247,.35);
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .hint{
      color:rgba(234,240,255,.45);
      font-size:12px;
      line-height:1.4;
    }
    .hint code{
      color:rgba(234,240,255,.75);
      background:rgba(255,255,255,.06);
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.07);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Live</div>
      <div class="pill"><span id="dot" class="dot"></span><span id="statusText">idle</span></div>
    </div>

    <div class="card">
      <div class="label">Подключение</div>
      <div class="ctrls">
        <div class="row">
          <input id="raceUrl" placeholder="Вставь ссылку RaceMann (…/Race/id/…#race)" />
        </div>
        <div class="row">
          <input id="workerBase" placeholder="Worker base URL (например https://racemann-api.vsmirnoff.workers.dev)" />
        </div>
        <div class="row">
          <button id="btnStart" class="primary">Start</button>
          <button id="btnStop" disabled>Stop</button>
          <button id="btnClear">Clear</button>
        </div>
        <div class="hint">
          UI будет раз в секунду делать запрос: <code>{workerBase}/state?raceUrl=...</code><br/>
          Ссылку и workerBase сохраняем в браузере (localStorage).
        </div>
      </div>
    </div>

    <div class="card">
      <div class="label">Last lap</div>
      <div id="lastLap" class="big">—</div>
      <div class="smallrow">
        <div>Δ к best: <span id="deltaBest">—</span></div>
        <div>poll: <span id="pollMs">—</span></div>
      </div>
    </div>

    <div class="card">
      <div class="label">Best lap</div>
      <div id="bestLap" class="big accent">—</div>
    </div>

    <div class="card">
      <div class="label">Current lap</div>
      <div id="currentLap" class="big">—</div>
      <div class="smallrow">
        <div>source: <span id="source">—</span></div>
        <div>ts: <span id="ts">—</span></div>
      </div>
    </div>

    <div class="card">
      <div class="label">Debug</div>
      <div id="debug" class="debug">{}</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const raceUrlEl = $("raceUrl");
    const workerBaseEl = $("workerBase");
    const btnStart = $("btnStart");
    const btnStop  = $("btnStop");
    const btnClear = $("btnClear");

    const dot = $("dot");
    const statusText = $("statusText");

    const lastLapEl = $("lastLap");
    const bestLapEl = $("bestLap");
    const currentLapEl = $("currentLap");
    const deltaBestEl = $("deltaBest");
    const pollMsEl = $("pollMs");
    const sourceEl = $("source");
    const tsEl = $("ts");
    const debugEl = $("debug");

    let timer = null;

    function setStatus(kind, text){
      dot.className = "dot" + (kind ? (" " + kind) : "");
      statusText.textContent = text;
    }

    function fmt(v){
      if (v === null || v === undefined) return "—";
      if (typeof v === "number") return v.toFixed(3);
      return String(v);
    }

    function loadSaved(){
      raceUrlEl.value = localStorage.getItem("raceUrl") || "";
      workerBaseEl.value = localStorage.getItem("workerBase") || "https://racemann-api.vsmirnoff.workers.dev";
    }

    function save(){
      localStorage.setItem("raceUrl", raceUrlEl.value.trim());
      localStorage.setItem("workerBase", workerBaseEl.value.trim().replace(/\/+$/,""));
    }

    async function pollOnce(){
      const t0 = performance.now();
      const raceUrl = raceUrlEl.value.trim();
      const base = workerBaseEl.value.trim().replace(/\/+$/,"");

      if(!raceUrl || !base){
        setStatus("bad","no url");
        return;
      }

      const url = base + "/state?raceUrl=" + encodeURIComponent(raceUrl) + "&_=" + Date.now();

      try{
        const r = await fetch(url, { cache: "no-store" });
        const ms = Math.round(performance.now() - t0);
        pollMsEl.textContent = ms + " ms";

        if(!r.ok){
          setStatus("bad", "http " + r.status);
          const txt = await r.text().catch(()=> "");
          debugEl.textContent = txt || ("HTTP " + r.status);
          sourceEl.textContent = "error";
          return;
        }

        const data = await r.json();
        setStatus("ok", data.status || "ok");
        sourceEl.textContent = "fetch";
        tsEl.textContent = data.ts ?? "—";

        // ожидаем такой формат (как ты показывал):
        // { status, sessionTime, currentLapTime, lastLap, bestLap, ... }
        currentLapEl.textContent = fmt(data.currentLapTime);
        lastLapEl.textContent    = fmt(data.lastLap);
        bestLapEl.textContent    = fmt(data.bestLap);

        if (typeof data.bestLap === "number" && typeof data.lastLap === "number"){
          const d = data.lastLap - data.bestLap;
          deltaBestEl.textContent = (d >= 0 ? "+" : "") + d.toFixed(3);
        } else {
          deltaBestEl.textContent = "—";
        }

        debugEl.textContent = JSON.stringify(data, null, 2);
      } catch(e){
        setStatus("bad","fetch error");
        sourceEl.textContent = "error";
        debugEl.textContent = String(e);
      }
    }

    function start(){
      save();
      if (timer) clearInterval(timer);
      setStatus("", "starting");
      pollOnce();
      timer = setInterval(pollOnce, 1000);
      btnStart.disabled = true;
      btnStop.disabled = false;
    }

    function stop(){
      if (timer) clearInterval(timer);
      timer = null;
      setStatus("", "stopped");
      btnStart.disabled = false;
      btnStop.disabled = true;
    }

    btnStart.addEventListener("click", start);
    btnStop.addEventListener("click", stop);
    btnClear.addEventListener("click", () => {
      raceUrlEl.value = "";
      localStorage.removeItem("raceUrl");
    });

    loadSaved();
    setStatus("", "idle");
  </script>
</body>
</html>